---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import CodeItem from '../components/CodeItem.astro';
import Footer from '../components/Footer.astro';

interface GameData {
  slug: string;
  name: string;
  thumbnail: string;
  description: string;
  metaTitle: string;
  metaDescription: string;
  lastUpdated: string;
  activeCodes: { code: string; reward: string }[];
  expiredCodes: { code: string; reward: string }[];
  howToRedeem: string[];
  introText?: string;
  whatAreCodes?: string;
  howToGetCodes?: string;
  playerCount?: number;
  totalVisits?: number;
  likes?: number;
  genre?: string;
  placeId?: number;
}

export async function getStaticPaths() {
  const gameModules = import.meta.glob<GameData>('../../data/games/*.json', {
    eager: true,
    import: 'default',
  });

  return Object.values(gameModules).map((game) => ({
    params: { slug: game.slug },
    props: { game },
  }));
}

const { game } = Astro.props;

const dateLabel = new Date(game.lastUpdated).toLocaleDateString('es-ES', {
  day: 'numeric',
  month: 'long',
  year: 'numeric',
});

function formatNumber(n: number): string {
  if (n >= 1_000_000_000) return `${(n / 1_000_000_000).toFixed(1).replace('.0', '')}B`;
  if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1).replace('.0', '')}M`;
  if (n >= 1_000) return `${(n / 1_000).toFixed(1).replace('.0', '')}K`;
  return n.toString();
}

const validThumb = game.thumbnail && game.thumbnail.startsWith('https://tr.rbxcdn.com');

const faqEntries: { '@type': string; name: string; acceptedAnswer: { '@type': string; text: string } }[] = [
  {
    '@type': 'Question',
    name: `¿Cuáles son los códigos activos de ${game.name} en Roblox?`,
    acceptedAnswer: {
      '@type': 'Answer',
      text:
        game.activeCodes.length > 0
          ? `Los códigos activos para ${game.name} son: ${game.activeCodes.map((c) => `${c.code} (${c.reward})`).join(', ')}.`
          : `Actualmente no hay códigos activos para ${game.name}.`,
    },
  },
  {
    '@type': 'Question',
    name: `¿Cómo canjear códigos en ${game.name}?`,
    acceptedAnswer: {
      '@type': 'Answer',
      text: game.howToRedeem.map((step, i) => `${i + 1}. ${step}`).join(' '),
    },
  },
];

if (game.whatAreCodes) {
  faqEntries.push({
    '@type': 'Question',
    name: `¿Qué son los códigos de ${game.name}?`,
    acceptedAnswer: { '@type': 'Answer', text: game.whatAreCodes },
  });
}

if (game.howToGetCodes) {
  faqEntries.push({
    '@type': 'Question',
    name: `¿Cómo conseguir más códigos de ${game.name}?`,
    acceptedAnswer: { '@type': 'Answer', text: game.howToGetCodes },
  });
}

const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqEntries,
};
---

<Layout
  title={game.metaTitle}
  description={game.metaDescription}
  ogImage={validThumb ? game.thumbnail : undefined}
>
  <script
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify(faqSchema)}
  />

  <Header />

  <main class="main">
    <div class="page-wrap">
      <!-- Hero -->
      <section class="hero">
        <div class="hero__img-wrap">
          {validThumb ? (
            <img
              src={game.thumbnail}
              alt={game.name}
              class="hero__img"
              loading="eager"
            />
          ) : (
            <div class="hero__placeholder">
              <span class="hero__placeholder-text">{game.name}</span>
            </div>
          )}
        </div>
        <div class="hero__info">
          <h1 class="hero__title">{game.name}</h1>
          <p class="hero__desc">{game.description}</p>
          <div class="hero__badges">
            <span class="badge badge--green">
              {game.activeCodes.length} código{game.activeCodes.length !== 1 && 's'} activo{game.activeCodes.length !== 1 && 's'}
            </span>
            <span class="badge badge--yellow">
              Actualizado {dateLabel}
            </span>
          </div>
        </div>
      </section>

      <!-- Stats -->
      {(game.playerCount || game.totalVisits || game.likes) && (
        <div class="stats">
          {game.playerCount && (
            <div class="stat">
              <span class="stat__value">{formatNumber(game.playerCount)}</span>
              <span class="stat__label">Jugando ahora</span>
            </div>
          )}
          {game.totalVisits && (
            <div class="stat">
              <span class="stat__value">{formatNumber(game.totalVisits)}</span>
              <span class="stat__label">Visitas totales</span>
            </div>
          )}
          {game.likes && (
            <div class="stat">
              <span class="stat__value">{formatNumber(game.likes)}</span>
              <span class="stat__label">Likes</span>
            </div>
          )}
        </div>
      )}

      <!-- Intro -->
      {game.introText && (
        <section class="section">
          <p class="intro-text">{game.introText}</p>
        </section>
      )}

      <!-- Códigos activos -->
      {game.activeCodes.length > 0 && (
        <section class="section">
          <h2 class="section__title">Códigos activos</h2>
          <div class="codes-list">
            {game.activeCodes.map((c) => (
              <CodeItem code={c.code} reward={c.reward} />
            ))}
          </div>
        </section>
      )}

      <!-- ¿Qué son los códigos? -->
      {game.whatAreCodes && (
        <section class="section">
          <h2 class="section__title">¿Qué son los códigos de {game.name}?</h2>
          <p class="section__text">{game.whatAreCodes}</p>
        </section>
      )}

      <!-- Códigos expirados -->
      {game.expiredCodes.length > 0 && (
        <section class="section">
          <h2 class="section__title section__title--dim">Códigos expirados</h2>
          <div class="codes-list">
            {game.expiredCodes.map((c) => (
              <CodeItem code={c.code} reward={c.reward} expired />
            ))}
          </div>
        </section>
      )}

      <!-- Cómo canjear -->
      {game.howToRedeem.length > 0 && (
        <section class="section">
          <h2 class="section__title">Cómo canjear códigos</h2>
          <div class="redeem-box">
            <ol class="redeem-steps">
              {game.howToRedeem.map((step) => (
                <li class="redeem-steps__item">{step}</li>
              ))}
            </ol>
            {game.placeId && (
              <a
                href={`https://www.roblox.com/games/${game.placeId}`}
                target="_blank"
                rel="noopener noreferrer"
                class="roblox-link"
              >
                Abrir {game.name} en Roblox
              </a>
            )}
          </div>
        </section>
      )}

      <!-- ¿Cómo conseguir más códigos? -->
      {game.howToGetCodes && (
        <section class="section">
          <h2 class="section__title">¿Cómo conseguir más códigos de {game.name}?</h2>
          <p class="section__text">{game.howToGetCodes}</p>
        </section>
      )}
    </div>
  </main>

  <Footer />
</Layout>

<style>
  .main {
    padding: 2rem 0 3rem;
  }

  .page-wrap {
    width: 100%;
    max-width: 760px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  /* ---- Hero ---- */
  .hero {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }

  @media (min-width: 640px) {
    .hero {
      flex-direction: row;
      align-items: flex-start;
    }
  }

  .hero__img-wrap {
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: var(--bg-card);
    flex-shrink: 0;
  }

  @media (min-width: 640px) {
    .hero__img-wrap {
      width: 200px;
    }
  }

  .hero__img {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
  }

  .hero__placeholder {
    width: 100%;
    aspect-ratio: 1 / 1;
    background: linear-gradient(135deg, #1a2236 0%, #0f3460 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.25rem;
  }

  .hero__placeholder-text {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
    text-align: center;
    line-height: 1.2;
    opacity: 0.9;
  }

  .hero__info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .hero__title {
    font-family: var(--font-display);
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.2;
  }

  @media (min-width: 640px) {
    .hero__title {
      font-size: 2rem;
    }
  }

  .hero__desc {
    color: var(--text-dim);
    font-size: 0.95rem;
  }

  .hero__badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.25rem;
  }

  .badge {
    font-family: var(--font-display);
    font-size: 0.78rem;
    font-weight: 700;
    padding: 0.3rem 0.75rem;
    border-radius: 9999px;
  }

  .badge--green {
    color: var(--accent);
    background: rgba(6, 214, 160, 0.1);
  }

  .badge--yellow {
    color: var(--accent-warn);
    background: rgba(255, 209, 102, 0.1);
  }

  /* ---- Stats ---- */
  .stats {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
    flex: 1;
    min-width: 90px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 0.5rem;
  }

  .stat__value {
    font-family: var(--font-display);
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--accent);
  }

  .stat__label {
    font-size: 0.75rem;
    color: var(--text-dim);
    text-align: center;
  }

  /* ---- Secciones ---- */
  .section {
    margin-bottom: 2.5rem;
  }

  .section__title {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .section__title--dim {
    color: var(--text-dim);
  }

  .section__text {
    color: var(--text-dim);
    font-size: 0.95rem;
    line-height: 1.7;
  }

  .intro-text {
    color: var(--text);
    font-size: 1rem;
    line-height: 1.7;
  }

  .codes-list {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
  }

  /* ---- Cómo canjear ---- */
  .redeem-box {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
  }

  .redeem-steps {
    list-style: none;
    counter-reset: step;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .redeem-steps__item {
    counter-increment: step;
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .redeem-steps__item::before {
    content: counter(step);
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--accent);
    background: rgba(6, 214, 160, 0.1);
    min-width: 1.75rem;
    height: 1.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .roblox-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.6rem 1.25rem;
    background: var(--accent);
    color: var(--bg-deep);
    font-family: var(--font-display);
    font-size: 0.85rem;
    font-weight: 700;
    border-radius: 8px;
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .roblox-link:hover {
    opacity: 0.85;
  }
</style>
