---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import CodeItem from '../components/CodeItem.astro';
import GameCard from '../components/GameCard.astro';
import Footer from '../components/Footer.astro';

interface GameData {
  slug: string;
  name: string;
  thumbnail: string;
  description: string;
  metaTitle: string;
  metaDescription: string;
  lastUpdated: string;
  activeCodes: { code: string; reward: string }[];
  expiredCodes: { code: string; reward: string }[];
  howToRedeem: string[];
  noCodeSystem?: boolean;
  noCodeNote?: string;
  introText?: string;
  whatAreCodes?: string;
  howToGetCodes?: string;
  playerCount?: number;
  totalVisits?: number;
  likes?: number;
  favourites?: number;
  genre?: string;
  placeId?: number;
  universeId?: number;
  developer?: string;
}

export async function getStaticPaths() {
  const gameModules = import.meta.glob<GameData>('../../data/games/*.json', {
    eager: true,
    import: 'default',
  });

  const allGames = Object.values(gameModules);

  return allGames.map((game) => ({
    params: { slug: game.slug },
    props: { game, allGames },
  }));
}

const { game, allGames } = Astro.props;

// Pick 4 random related games with active codes
const candidates = (allGames as GameData[]).filter(
  (g) => g.slug !== game.slug && g.activeCodes.length > 0
);
for (let i = candidates.length - 1; i > 0; i--) {
  const j = Math.floor(Math.random() * (i + 1));
  [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
}
const relatedGames = candidates.slice(0, 4);

const dateLabel = new Date(game.lastUpdated).toLocaleDateString('es-ES', {
  day: 'numeric',
  month: 'long',
  year: 'numeric',
});

function formatNumber(n: number): string {
  if (n >= 1_000_000_000) return `${(n / 1_000_000_000).toFixed(1).replace('.0', '')}B`;
  if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1).replace('.0', '')}M`;
  if (n >= 1_000) return `${(n / 1_000).toFixed(1).replace('.0', '')}K`;
  return n.toString();
}

const validThumb = game.thumbnail && game.thumbnail.startsWith('https://tr.rbxcdn.com');

// Fallback SEO texts — use JSON field if present, otherwise generate from data
const favCount = game.favourites || game.likes || 0;
const devName = game.developer || '';
const genreLabel = game.genre && game.genre !== 'All' ? ` de ${game.genre}` : '';
const visitsLabel = game.totalVisits ? `más de ${formatNumber(game.totalVisits)} visitas` : '';
const favsLabel = favCount ? `${formatNumber(favCount)} favoritos` : '';
const statsPhrase = [visitsLabel, favsLabel].filter(Boolean).join(' y ');

const introContent = game.introText
  || `${game.name} es un juego${genreLabel} en Roblox${devName ? ` creado por ${devName}` : ''}. ${statsPhrase ? `El juego tiene ${statsPhrase}. ` : ''}Actualmente tenemos ${game.activeCodes.length} código${game.activeCodes.length !== 1 ? 's' : ''} activo${game.activeCodes.length !== 1 ? 's' : ''} y ${game.expiredCodes.length} código${game.expiredCodes.length !== 1 ? 's' : ''} expirado${game.expiredCodes.length !== 1 ? 's' : ''} para ${game.name}.`;

const whatAreCodesContent = game.whatAreCodes
  || `Los códigos de ${game.name} son combinaciones de texto que puedes canjear dentro del juego para obtener recompensas gratuitas como monedas, gemas, potenciadores y objetos exclusivos sin gastar Robux.`;

const howToGetCodesContent = game.howToGetCodes
  || `Guarda esta página en favoritos porque la actualizamos regularmente.${devName ? ` También puedes seguir a ${devName} en Roblox para enterarte de los nuevos códigos.` : ''} Los códigos suelen publicarse en el Discord del juego y con cada actualización.`;

const mesesES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const now = new Date();
const mesAnio = `${mesesES[now.getMonth()]} ${now.getFullYear()}`;
const isRoblox = !!(game.placeId);
const robloxLabel = isRoblox ? ' Roblox' : '';
const displayName = game.name.startsWith('Códigos') ? game.name : `Códigos ${game.name}`;
const imgAlt = game.name.startsWith('Códigos') ? `${game.name} Roblox` : `Códigos ${game.name} Roblox`;
const activeCount = game.activeCodes.length;

const dynamicTitle = `Códigos ${game.name}${robloxLabel} (${mesAnio}) — Códigos Gratis`;
const dynamicDescription = activeCount > 0
  ? `Códigos actualizados de ${game.name}${robloxLabel} para ${mesAnio}. ${activeCount} códigos activos verificados. Canjea recompensas gratis ahora. ¡Lista actualizada hoy!`
  : `Códigos de ${game.name}${robloxLabel} para ${mesAnio}. Consulta todos los códigos activos y expirados. ¡Actualizamos a diario!`;

const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: [
    {
      '@type': 'Question',
      name: `¿Cuáles son los códigos activos de ${game.name}?`,
      acceptedAnswer: {
        '@type': 'Answer',
        text:
          game.activeCodes.length > 0
            ? `Los códigos activos de ${game.name} son: ${game.activeCodes.map((c) => c.code).join(', ')}.`
            : `Actualmente no hay códigos activos para ${game.name}. Revisamos a diario y actualizamos esta página en cuanto se publican nuevos códigos.`,
      },
    },
    {
      '@type': 'Question',
      name: `¿Cómo canjear códigos en ${game.name}?`,
      acceptedAnswer: {
        '@type': 'Answer',
        text: game.howToRedeem.length > 0
          ? game.howToRedeem.map((step, i) => `${i + 1}. ${step}`).join(' ')
          : `Abre ${game.name} en Roblox, busca el botón de códigos en el menú del juego, escribe o pega el código y pulsa Canjear.`,
      },
    },
    {
      '@type': 'Question',
      name: `¿Por qué no funcionan los códigos de ${game.name}?`,
      acceptedAnswer: {
        '@type': 'Answer',
        text: `Los códigos de ${game.name} pueden no funcionar por varios motivos: el código ha expirado y ya no es válido, hay un error tipográfico al escribirlo (copia y pega para evitarlo), o ya lo has canjeado anteriormente en tu cuenta, ya que cada código solo se puede usar una vez.`,
      },
    },
  ],
};
---

<Layout
  title={dynamicTitle}
  description={dynamicDescription}
  ogImage={validThumb ? game.thumbnail : undefined}
>
  <script
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify(faqSchema)}
  />

  <Header />

  <main class="main">
    <div class="page-wrap">
      <!-- Breadcrumbs -->
      <nav class="breadcrumbs">
        <a href="/">Inicio</a> <span class="breadcrumbs__sep">›</span>
        <span>Códigos de {game.name}</span>
      </nav>

      <!-- Hero -->
      <section class="hero">
        <div class="hero__img-wrap">
          {validThumb ? (
            <img
              src={game.thumbnail}
              alt={imgAlt}
              class="hero__img"
              loading="eager"
            />
          ) : (
            <div class="hero__placeholder">
              <span class="hero__placeholder-text">{game.name}</span>
            </div>
          )}
        </div>
        <div class="hero__info">
          <h1 class="hero__title">{displayName}</h1>
          <p class="hero__desc">{game.description}</p>
          <div class="hero__badges">
            {game.noCodeSystem ? (
              <span class="badge badge--dim">Sin sistema de códigos</span>
            ) : (
              <a href="#codigos" class="badge badge--green badge--link">
                {game.activeCodes.length} código{game.activeCodes.length !== 1 && 's'} activo{game.activeCodes.length !== 1 && 's'} <span class="badge__arrow">↓</span>
              </a>
            )}
            <span class="badge badge--yellow">
              Actualizado {dateLabel}
            </span>
          </div>
        </div>
      </section>

      <!-- Stats -->
      {(game.playerCount || game.totalVisits || game.likes || game.favourites) && (
        <div class="stats">
          {game.playerCount && (
            <div class="stat">
              <span class="stat__value">{formatNumber(game.playerCount)}</span>
              <span class="stat__label">Jugando ahora</span>
            </div>
          )}
          {game.totalVisits && (
            <div class="stat">
              <span class="stat__value">{formatNumber(game.totalVisits)}</span>
              <span class="stat__label">Visitas totales</span>
            </div>
          )}
          {game.favourites && (
            <div class="stat">
              <span class="stat__value">{formatNumber(game.favourites)}</span>
              <span class="stat__label">Favoritos</span>
            </div>
          )}
          {game.likes && !game.favourites && (
            <div class="stat">
              <span class="stat__value">{formatNumber(game.likes)}</span>
              <span class="stat__label">Likes</span>
            </div>
          )}
        </div>
      )}

      <!-- Intro -->
      <section class="section">
        <p class="intro-text">{introContent}</p>
      </section>

      <!-- Aviso: sin sistema de códigos -->
      {game.noCodeSystem && game.noCodeNote && (
        <section class="section">
          <div class="no-codes-notice">
            <span class="no-codes-notice__icon">ℹ️</span>
            <p class="no-codes-notice__text">{game.noCodeNote}</p>
          </div>
        </section>
      )}

      <!-- Códigos activos -->
      {game.activeCodes.length > 0 && (
        <section class="section" id="codigos">
          <h2 class="section__title">Códigos activos</h2>
          <p class="codes-check">Última comprobación: {dateLabel}</p>
          <div class="codes-list">
            {game.activeCodes.map((c, i) => (
              <div class="code-numbered">
                <span class="code-number">{i + 1}</span>
                <CodeItem code={c.code} reward={c.reward} />
              </div>
            ))}
          </div>
        </section>
      )}

      <!-- ¿Qué son los códigos? -->
      <section class="section">
        <h2 class="section__title">¿Qué son los códigos de {game.name}?</h2>
        <p class="section__text">{whatAreCodesContent}</p>
      </section>

      <!-- Códigos expirados -->
      {game.expiredCodes.length > 0 && (
        <section class="section">
          <h2 class="section__title section__title--dim">Códigos expirados</h2>
          <div class="codes-list">
            {game.expiredCodes.map((c) => (
              <CodeItem code={c.code} reward={c.reward} expired />
            ))}
          </div>
        </section>
      )}

      <!-- Cómo canjear -->
      {game.howToRedeem.length > 0 && (
        <section class="section">
          <h2 class="section__title">Cómo canjear códigos</h2>
          <div class="redeem-box">
            <ol class="redeem-steps">
              {game.howToRedeem.map((step) => (
                <li class="redeem-steps__item">{step}</li>
              ))}
            </ol>
            {game.placeId && (
              <a
                href={`https://www.roblox.com/games/${game.placeId}`}
                target="_blank"
                rel="noopener noreferrer"
                class="roblox-link"
              >
                Abrir {game.name} en Roblox
              </a>
            )}
          </div>
        </section>
      )}

      <!-- ¿Cómo conseguir más códigos? -->
      <section class="section">
        <h2 class="section__title">¿Cómo conseguir más códigos de {game.name}?</h2>
        <p class="section__text">{howToGetCodesContent}</p>
      </section>

      <!-- ¿Por qué no funcionan los códigos? -->
      <section class="section">
        <h2 class="section__title">¿Por qué no funcionan los códigos?</h2>
        <div class="reasons-box">
          <ul class="reasons-list">
            <li><strong>El código ha expirado:</strong> los desarrolladores desactivan códigos sin previo aviso. Consulta nuestra lista de códigos expirados más arriba.</li>
            <li><strong>Error al escribirlo:</strong> copia y pega el código directamente para evitar errores tipográficos. Las mayúsculas y minúsculas importan.</li>
            <li><strong>Ya lo canjeaste antes:</strong> cada código solo se puede usar una vez por cuenta.</li>
            <li><strong>Tu cuenta no cumple los requisitos:</strong> algunos códigos requieren un nivel mínimo o haber completado cierto tutorial.</li>
          </ul>
        </div>
      </section>

      <!-- Tabla sobre el juego -->
      {(game.genre || game.totalVisits || game.likes || game.favourites || game.developer || game.placeId) && (
        <section class="section">
          <h2 class="section__title">Sobre {game.name}</h2>
          <div class="info-table-wrap">
            <table class="info-table">
              <tbody>
                {game.developer && (
                  <tr>
                    <td class="info-table__label">Desarrollador</td>
                    <td class="info-table__value">{game.developer}</td>
                  </tr>
                )}
                {game.genre && game.genre !== 'All' && (
                  <tr>
                    <td class="info-table__label">Género</td>
                    <td class="info-table__value">{game.genre}</td>
                  </tr>
                )}
                {game.totalVisits && (
                  <tr>
                    <td class="info-table__label">Visitas totales</td>
                    <td class="info-table__value">{game.totalVisits.toLocaleString('es-ES')}</td>
                  </tr>
                )}
                {game.favourites && (
                  <tr>
                    <td class="info-table__label">Favoritos</td>
                    <td class="info-table__value">{game.favourites.toLocaleString('es-ES')}</td>
                  </tr>
                )}
                {game.likes && !game.favourites && (
                  <tr>
                    <td class="info-table__label">Likes</td>
                    <td class="info-table__value">{game.likes.toLocaleString('es-ES')}</td>
                  </tr>
                )}
                {game.placeId && (
                  <tr>
                    <td class="info-table__label">Enlace Roblox</td>
                    <td class="info-table__value">
                      <a href={`https://www.roblox.com/games/${game.placeId}`} target="_blank" rel="noopener noreferrer" class="info-table__link">
                        Jugar en Roblox
                      </a>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      )}

      <!-- Más juegos con códigos -->
      {relatedGames.length > 0 && (
        <section class="section">
          <h2 class="section__title">Más juegos con códigos</h2>
          <div class="related-grid">
            {relatedGames.map((g) => (
              <GameCard
                name={g.name}
                slug={g.slug}
                image={g.thumbnail}
                activeCodes={g.activeCodes.length}
                lastUpdated={g.lastUpdated}
              />
            ))}
          </div>
        </section>
      )}
    </div>
  </main>

  <Footer />
</Layout>

<style>
  .main {
    padding: 2rem 0 3rem;
  }

  .page-wrap {
    width: 100%;
    max-width: 760px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  /* ---- Hero ---- */
  .hero {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }

  @media (min-width: 640px) {
    .hero {
      flex-direction: row;
      align-items: flex-start;
    }
  }

  .hero__img-wrap {
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: var(--bg-card);
    flex-shrink: 0;
  }

  @media (min-width: 640px) {
    .hero__img-wrap {
      width: 200px;
    }
  }

  .hero__img {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
  }

  .hero__placeholder {
    width: 100%;
    aspect-ratio: 1 / 1;
    background: linear-gradient(135deg, #1a2236 0%, #0f3460 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.25rem;
  }

  .hero__placeholder-text {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
    text-align: center;
    line-height: 1.2;
    opacity: 0.9;
  }

  .hero__info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .hero__title {
    font-family: var(--font-display);
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.2;
  }

  @media (min-width: 640px) {
    .hero__title {
      font-size: 2rem;
    }
  }

  .hero__desc {
    color: var(--text-dim);
    font-size: 0.95rem;
  }

  .hero__badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.25rem;
  }

  .badge {
    font-family: var(--font-display);
    font-size: 0.78rem;
    font-weight: 700;
    padding: 0.3rem 0.75rem;
    border-radius: 9999px;
  }

  .badge--green {
    color: var(--accent);
    background: rgba(6, 214, 160, 0.1);
  }

  .badge--link {
    cursor: pointer;
    text-decoration: none;
    transition: background 0.2s, box-shadow 0.2s;
  }

  .badge--link:hover {
    background: rgba(6, 214, 160, 0.22);
    box-shadow: 0 0 12px rgba(6, 214, 160, 0.15);
  }

  .badge__arrow {
    font-size: 0.7em;
    margin-left: 0.15rem;
    display: inline-block;
    transition: transform 0.2s;
  }

  .badge--link:hover .badge__arrow {
    transform: translateY(2px);
  }

  .badge--yellow {
    color: var(--accent-warn);
    background: rgba(255, 209, 102, 0.1);
  }

  .badge--dim {
    color: var(--text-dim);
    background: rgba(255, 255, 255, 0.06);
  }

  /* ---- No codes notice ---- */
  .no-codes-notice {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    background: rgba(255, 209, 102, 0.08);
    border: 1px solid rgba(255, 209, 102, 0.2);
    border-radius: 12px;
  }

  .no-codes-notice__icon {
    font-size: 1.25rem;
    flex-shrink: 0;
    line-height: 1.5;
  }

  .no-codes-notice__text {
    color: var(--text);
    font-size: 0.95rem;
    line-height: 1.6;
  }

  /* ---- Stats ---- */
  .stats {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
    flex: 1;
    min-width: 90px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 0.5rem;
  }

  .stat__value {
    font-family: var(--font-display);
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--accent);
  }

  .stat__label {
    font-size: 0.75rem;
    color: var(--text-dim);
    text-align: center;
  }

  /* ---- Secciones ---- */
  .section {
    margin-bottom: 2.5rem;
  }

  .section__title {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .section__title--dim {
    color: var(--text-dim);
  }

  .section__text {
    color: var(--text-dim);
    font-size: 0.95rem;
    line-height: 1.7;
  }

  .intro-text {
    color: var(--text);
    font-size: 1rem;
    line-height: 1.7;
  }

  .codes-list {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
  }

  /* ---- Cómo canjear ---- */
  .redeem-box {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
  }

  .redeem-steps {
    list-style: none;
    counter-reset: step;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .redeem-steps__item {
    counter-increment: step;
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .redeem-steps__item::before {
    content: counter(step);
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--accent);
    background: rgba(6, 214, 160, 0.1);
    min-width: 1.75rem;
    height: 1.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .roblox-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.6rem 1.25rem;
    background: var(--accent);
    color: var(--bg-deep);
    font-family: var(--font-display);
    font-size: 0.85rem;
    font-weight: 700;
    border-radius: 8px;
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .roblox-link:hover {
    opacity: 0.85;
  }

  /* ---- Breadcrumbs ---- */
  .breadcrumbs {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-bottom: 1.25rem;
  }

  .breadcrumbs a {
    color: var(--text-dim);
    text-decoration: none;
    transition: color 0.2s;
  }

  .breadcrumbs a:hover {
    color: var(--accent);
  }

  .breadcrumbs__sep {
    margin: 0 0.35rem;
    opacity: 0.5;
  }

  /* ---- Última comprobación ---- */
  .codes-check {
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-bottom: 0.75rem;
  }

  /* ---- Códigos numerados ---- */
  .code-numbered {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .code-number {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--accent);
    background: rgba(6, 214, 160, 0.1);
    min-width: 1.75rem;
    height: 1.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .code-numbered :global(.code-item) {
    flex: 1;
    min-width: 0;
  }

  /* ---- Por qué no funcionan ---- */
  .reasons-box {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
  }

  .reasons-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 0;
    margin: 0;
  }

  .reasons-list li {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-dim);
    padding-left: 1.25rem;
    position: relative;
  }

  .reasons-list li::before {
    content: '•';
    position: absolute;
    left: 0;
    color: var(--accent-hot);
    font-weight: 700;
  }

  .reasons-list li strong {
    color: var(--text);
  }

  /* ---- Tabla info ---- */
  .info-table-wrap {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .info-table {
    width: 100%;
    border-collapse: collapse;
  }

  .info-table tr:not(:last-child) {
    border-bottom: 1px solid var(--border);
  }

  .info-table td {
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
  }

  .info-table__label {
    color: var(--text-dim);
    width: 40%;
    font-weight: 600;
  }

  .info-table__value {
    color: var(--text);
  }

  .info-table__link {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    transition: opacity 0.2s;
  }

  .info-table__link:hover {
    opacity: 0.8;
  }

  /* ---- Juegos relacionados ---- */
  .related-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  @media (min-width: 640px) {
    .related-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
</style>
