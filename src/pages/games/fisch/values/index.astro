---
import GameLayout from '../../../../layouts/GameLayout.astro';
import FischHero from '../../../../components/FischHero.astro';
import TradeItemGrid from '../../../../components/TradeItemGrid.tsx';
import type { TradeItem } from '../../../../components/TradeItemGrid.tsx';

import rodSkinsData from '../../../../data/games/fisch/rod-skins.json';
import boatsData from '../../../../data/games/fisch/boats.json';

// ---------- Data ----------

const allItems: (TradeItem & { itemType: string })[] = [
  ...(rodSkinsData as any[]).map(i => ({ ...i, itemType: 'rod_skin' })),
  ...(boatsData as any[]).map(i => ({ ...i, itemType: 'boat' })),
]
  .filter(i => i.name && i.slug)
  .map(i => ({
    name: i.name,
    slug: i.slug,
    tradeValue: i.tradeValue,
    demand: i.demand,
    trend: i.trend,
    rarity: i.rarity,
    imageUrl: i.imageUrl,
    itemType: i.itemType,
  }));

const gridItems: TradeItem[] = allItems.map(i => ({ ...i }));

const total = allItems.length;
const rodCount = allItems.filter(i => i.itemType === 'rod_skin').length;
const boatCount = allItems.filter(i => i.itemType === 'boat').length;
const fmt = (n: number) => n.toLocaleString('en-US');

function fmtVal(n: number | null): string {
  if (n == null) return 'â€”';
  if (n >= 1000) return `${(n / 1000).toFixed(n % 1000 === 0 ? 0 : 1)}K`;
  if (Number.isInteger(n)) return String(n);
  return n.toFixed(1);
}

const sources = [...new Set(allItems.map(i => i.rarity).filter(Boolean) as string[])]
  .sort((a, b) => {
    const count = (s: string) => allItems.filter(i => i.rarity === s).length;
    return count(b) - count(a);
  });

// Top 10 most valuable
const top10 = [...allItems]
  .filter(i => i.tradeValue != null && i.tradeValue > 0)
  .sort((a, b) => (b.tradeValue || 0) - (a.tradeValue || 0))
  .slice(0, 10);

const SOURCE_COLORS: Record<string, string> = {
  Limited: '#ef4444', Robux: '#22c55e', Regular: '#3b82f6', Code: '#f59e0b',
  Egg: '#ec4899', Merch: '#a855f7', 'Pirate Faction': '#f97316', Challenge: '#06b6d4',
  'Friend Quest': '#8b5cf6', DLC: '#14b8a6', Event: '#f43f5e', Exclusive: '#fbbf24',
  'Skin Merchant': '#c084fc',
};

const DEMAND_COLORS: Record<string, string> = {
  'Very High': '#ef4444', High: '#f59e0b', Medium: '#22c55e', Low: '#3b82f6', 'Very Low': '#6b7280',
};

// Schema.org
const pageUrl = new URL('/games/fisch/values/', Astro.site).href;

const webPageSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebPage',
  name: 'Fisch Trading Value List - All Items',
  description: `Complete Fisch trading value list with ${fmt(total)} tradeable items. Rod skins and boats with Enchant Relic values, demand, and trends.`,
  url: pageUrl,
  publisher: { '@type': 'Organization', name: 'Codigos Gratis' },
};

const itemListSchema = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: 'Fisch Trading Value List',
  numberOfItems: total,
  itemListElement: top10.map((item, i) => {
    const basePath = item.itemType === 'boat' ? '/games/fisch/boats' : '/games/fisch/rod-skins';
    return {
      '@type': 'ListItem',
      position: i + 1,
      name: item.name,
      url: new URL(`${basePath}/${item.slug}/`, Astro.site).href,
    };
  }),
};
---

<GameLayout
  title={`Fisch Trading Value List - ${fmt(total)} Items with Enchant Relic Prices`}
  description={`Complete Fisch value list: ${fmt(rodCount)} rod skins and ${fmt(boatCount)} boats with trade values in Enchant Relics, demand levels, and market trends.`}
  game="Fisch"
  breadcrumbs={[{ label: 'Value List', href: '/games/fisch/values/' }]}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(webPageSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />
  </Fragment>

  <FischHero title="VALUE LIST" subtitle={`${fmt(total)} tradeable items`} />

  <div class="container">

    <!-- STATS BAR -->
    <div class="stats-bar">
      <div class="stats-bar__item">
        <span class="stats-bar__num">{fmt(total)}</span>
        <span class="stats-bar__label">Total Items</span>
      </div>
      <div class="stats-bar__item">
        <span class="stats-bar__num">{fmt(rodCount)}</span>
        <span class="stats-bar__label">Rod Skins</span>
      </div>
      <div class="stats-bar__item">
        <span class="stats-bar__num">{fmt(boatCount)}</span>
        <span class="stats-bar__label">Boats</span>
      </div>
    </div>

    <!-- TOP 10 MOST VALUABLE -->
    <section class="top10">
      <h2 class="section-heading">MOST VALUABLE</h2>
      <div class="top10__wrap">
        <table class="top10__table">
          <thead>
            <tr>
              <th class="top10__th">#</th>
              <th class="top10__th">Name</th>
              <th class="top10__th">Type</th>
              <th class="top10__th">Source</th>
              <th class="top10__th">Trade Value</th>
              <th class="top10__th">Demand</th>
            </tr>
          </thead>
          <tbody>
            {top10.map((item, i) => {
              const basePath = item.itemType === 'boat' ? '/games/fisch/boats' : '/games/fisch/rod-skins';
              const srcColor = SOURCE_COLORS[item.rarity || ''] || '#888';
              const demColor = DEMAND_COLORS[item.demand || ''] || '#888';
              return (
                <tr class="top10__row">
                  <td class="top10__td top10__td--rank">{i + 1}</td>
                  <td class="top10__td top10__td--name">
                    <a href={`${basePath}/${item.slug}/`} class="top10__link">{item.name}</a>
                  </td>
                  <td class="top10__td top10__td--type">
                    {item.itemType === 'boat' ? 'ðŸš¤' : 'ðŸŽ¨'}
                  </td>
                  <td class="top10__td">
                    <span style={`color: ${srcColor}`}>{item.rarity}</span>
                  </td>
                  <td class="top10__td top10__td--val">{fmtVal(item.tradeValue)} ER</td>
                  <td class="top10__td">
                    <span style={`color: ${demColor}`}>{item.demand || 'â€”'}</span>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </section>

    <!-- CTA LINKS -->
    <div class="cta-row">
      <a href="/games/fisch/rod-skins/" class="cta-card">
        <span class="cta-card__icon">ðŸŽ¨</span>
        <div class="cta-card__body">
          <strong class="cta-card__title">Rod Skins ({fmt(rodCount)})</strong>
          <span class="cta-card__desc">Browse all tradeable rod skins with values</span>
        </div>
        <span class="cta-card__arrow">&rarr;</span>
      </a>
      <a href="/games/fisch/boats/" class="cta-card">
        <span class="cta-card__icon">ðŸš¤</span>
        <div class="cta-card__body">
          <strong class="cta-card__title">Boats ({fmt(boatCount)})</strong>
          <span class="cta-card__desc">Browse all tradeable boats with values</span>
        </div>
        <span class="cta-card__arrow">&rarr;</span>
      </a>
    </div>

    <!-- ALL ITEMS GRID -->
    <section class="all-items">
      <h2 class="section-heading">ALL TRADEABLE ITEMS</h2>
      <TradeItemGrid
        client:load
        items={gridItems}
        sources={sources}
        basePath="/games/fisch/rod-skins"
      />
    </section>
  </div>
</GameLayout>

<style>
  .section-heading {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  /* Stats bar */
  .stats-bar {
    display: flex; gap: 0.75rem; margin-bottom: 1.25rem;
  }
  .stats-bar__item {
    flex: 1; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
    padding: 0.75rem 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.1rem;
  }
  .stats-bar__num { font-family: var(--font-display); font-size: 1.25rem; font-weight: 700; color: #22D3EE; }
  .stats-bar__label { font-size: 0.72rem; color: var(--text-dim); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

  /* Top 10 */
  .top10 { padding-bottom: 1.25rem; }
  .top10__wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 12px; background: var(--bg-card); }
  .top10__table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .top10__th { padding: 0.6rem 0.75rem; text-align: left; font-size: 0.72rem; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  .top10__row:not(:last-child) .top10__td { border-bottom: 1px solid rgba(30, 41, 59, 0.5); }
  .top10__td { padding: 0.55rem 0.75rem; vertical-align: middle; white-space: nowrap; }
  .top10__td--rank { font-family: var(--font-display); font-weight: 700; color: var(--text-dim); width: 2rem; text-align: center; }
  .top10__td--name { font-weight: 600; }
  .top10__td--type { text-align: center; width: 2.5rem; }
  .top10__td--val { font-family: var(--font-mono); font-weight: 700; color: #22D3EE; font-size: 0.9rem; }
  .top10__link { color: #fff; transition: color 0.2s; }
  .top10__link:hover { color: var(--accent); }

  @media (max-width: 639px) {
    .top10__td--type, .top10__th:nth-child(3) { display: none; }
  }

  /* CTA */
  .cta-row { display: grid; grid-template-columns: 1fr; gap: 0.65rem; margin-bottom: 1.5rem; }
  @media (min-width: 640px) { .cta-row { grid-template-columns: repeat(2, 1fr); } }
  .cta-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.85rem 1rem; background: rgba(6, 214, 160, 0.05); border: 1px solid rgba(6, 214, 160, 0.2); border-radius: 12px; transition: border-color 0.2s, background 0.2s; text-decoration: none; }
  .cta-card:hover { border-color: rgba(6, 214, 160, 0.45); background: rgba(6, 214, 160, 0.1); }
  .cta-card__icon { font-size: 1.3rem; flex-shrink: 0; }
  .cta-card__body { flex: 1; min-width: 0; }
  .cta-card__title { display: block; font-size: 0.88rem; font-weight: 700; color: var(--accent); line-height: 1.3; }
  .cta-card__desc { font-size: 0.78rem; color: var(--text-dim); line-height: 1.4; }
  .cta-card__arrow { font-size: 1.1rem; color: var(--accent); flex-shrink: 0; }

  /* All items */
  .all-items { padding-bottom: 1.5rem; }

  /* TradeItemGrid styles */
  :global(.tig__filters) { display:flex; flex-direction:column; gap:0.6rem; margin-bottom:0.75rem; }
  :global(.tig__search-wrap) { position:relative; }
  :global(.tig__search-ico) { position:absolute; left:0.75rem; top:50%; transform:translateY(-50%); color:var(--text-dim); pointer-events:none; }
  :global(.tig__search) { width:100%; background:var(--bg-card); border:1px solid var(--border); border-radius:10px; padding:0.6rem 0.75rem 0.6rem 2.25rem; color:var(--text); font-family:var(--font-body); font-size:0.9rem; outline:none; transition:border-color 0.2s, box-shadow 0.2s; }
  :global(.tig__search:focus) { border-color:var(--accent); box-shadow:0 0 0 3px rgba(6,214,160,0.15); }
  :global(.tig__search::placeholder) { color:var(--text-dim); }
  :global(.tig__filter-row) { display:flex; flex-wrap:wrap; gap:0.4rem; align-items:center; }
  :global(.tig__sort-btn), :global(.tig__src-btn) { background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:0.35rem 0.6rem; color:var(--text); font-family:var(--font-body); font-size:0.78rem; cursor:pointer; outline:none; transition:border-color 0.2s, background 0.2s; }
  :global(.tig__sort-btn:hover), :global(.tig__src-btn:hover) { border-color:rgba(6,214,160,0.3); }
  :global(.tig__sort-btn--active) { border-color:var(--accent); background:rgba(6,214,160,0.1); color:var(--accent); }
  :global(.tig__src-btn--active) { border-color:var(--src-color); background:color-mix(in srgb, var(--src-color) 12%, transparent); color:var(--src-color); }
  :global(.tig__divider) { width:1px; height:20px; background:var(--border); margin:0 0.25rem; }
  :global(.tig__clear) { background:none; border:1px solid var(--border); border-radius:8px; padding:0.35rem 0.55rem; color:var(--accent-hot); font-size:0.75rem; cursor:pointer; font-family:var(--font-body); transition:border-color 0.2s; }
  :global(.tig__clear:hover) { border-color:var(--accent-hot); }
  :global(.tig__count) { font-size:0.8rem; color:var(--text-dim); margin-bottom:0.6rem; font-weight:500; }
  :global(.tig__grid) { display:grid; grid-template-columns:repeat(2, 1fr); gap:0.75rem; }
  @media (min-width:640px)  { :global(.tig__grid) { grid-template-columns:repeat(3, 1fr); } }
  @media (min-width:1024px) { :global(.tig__grid) { grid-template-columns:repeat(4, 1fr); } }
  :global(.tig__card) { display:flex; flex-direction:column; background:var(--bg-card); border:1px solid var(--border); border-radius:12px; overflow:hidden; transition:border-color 0.2s, transform 0.15s, box-shadow 0.2s; text-decoration:none; }
  :global(.tig__card:hover) { border-color:var(--card-accent); transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.3); }
  :global(.tig__card-img) { aspect-ratio:1; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, color-mix(in srgb, var(--card-accent) 18%, transparent) 0%, var(--bg-card) 100%); padding:0.75rem; }
  :global(.tig__card-img img) { max-width:100%; max-height:100%; object-fit:contain; }
  :global(.tig__card-ph) { font-size:2rem; color:var(--text-dim); }
  :global(.tig__card-body) { padding:0.6rem 0.75rem 0.75rem; display:flex; flex-direction:column; gap:0.3rem; }
  :global(.tig__card-name) { font-size:0.82rem; font-weight:600; color:#fff; line-height:1.3; margin:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  :global(.tig__card-value) { font-family:var(--font-mono); font-size:0.9rem; font-weight:700; color:#22D3EE; }
  :global(.tig__card-badges) { display:flex; flex-wrap:wrap; gap:0.3rem; margin-top:0.1rem; }
  :global(.tig__badge) { display:inline-block; padding:0.1rem 0.4rem; border:1px solid var(--badge-color); border-radius:9999px; font-size:0.65rem; font-weight:600; letter-spacing:0.3px; color:var(--badge-color); background:color-mix(in srgb, var(--badge-color) 10%, transparent); }
  :global(.tig__badge--src) { font-size:0.6rem; }
  :global(.tig__empty) { text-align:center; padding:2rem 1rem; color:var(--text-dim); font-size:0.9rem; display:flex; flex-direction:column; align-items:center; gap:0.75rem; }
</style>
