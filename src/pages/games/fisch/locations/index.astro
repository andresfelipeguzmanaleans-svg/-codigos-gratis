---
import GameLayout from '../../../../layouts/GameLayout.astro';
import FischHero from '../../../../components/FischHero.astro';

import locationsData from '../../../../data/games/fisch/locations.json';
import fishData from '../../../../data/games/fisch/fish.json';

// ---------- Types ----------

interface LocFish {
  name: string;
  rarity: string;
}

interface Location {
  id: string;
  name: string;
  description: string | null;
  availableWeathers: string[];
  isPremium: boolean;
  isEvent: boolean;
  isSeasonal: boolean;
  fishCount: number;
  fish: LocFish[];
}

// ---------- Data ----------

const locations = (locationsData as Location[]).sort((a, b) => {
  // Events last, then by fish count desc, then alphabetical
  if (a.isEvent !== b.isEvent) return a.isEvent ? 1 : -1;
  if (b.fishCount !== a.fishCount) return b.fishCount - a.fishCount;
  return a.name.localeCompare(b.name);
});

// Fish name → id lookup for linking
const fishIdMap: Record<string, string> = {};
(fishData as any[]).forEach(f => {
  if (f.id && f.name) fishIdMap[f.name] = f.id;
});

const total = locations.length;
const totalFishSpots = locations.reduce((s, l) => s + l.fishCount, 0);
const regularLocs = locations.filter(l => !l.isEvent);
const eventLocs = locations.filter(l => l.isEvent);
const fmt = (n: number) => n.toLocaleString('en-US');

// Rarity colors for fish badges
const RARITY_COLORS: Record<string, string> = {
  'Trash': '#71717a', 'Common': '#9ca3af', 'Uncommon': '#22c55e', 'Unusual': '#34d39e',
  'Rare': '#3b82f6', 'Legendary': '#f59e0b', 'Mythical': '#a855f7', 'Exotic': '#ec4899',
  'Limited': '#ef4444', 'Special': '#06b6d4', 'Secret': '#fbbf24', 'Divine Secret': '#fde68a',
  'Apex': '#f43f5e', 'Extinct': '#a8a29e', 'Relic': '#c084fc', 'Gemstone': '#2dd4bf',
  'Fragment': '#67e8f9',
};

// Rarity sort order for fish within a location
const RARITY_ORDER: Record<string, number> = {
  'Apex': 0, 'Divine Secret': 1, 'Gemstone': 2, 'Relic': 3, 'Exotic': 4,
  'Secret': 5, 'Mythical': 6, 'Legendary': 7, 'Rare': 8, 'Unusual': 9,
  'Uncommon': 10, 'Common': 11, 'Special': 12, 'Limited': 13, 'Extinct': 14,
  'Fragment': 15, 'Trash': 16,
};

// Schema.org
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: `All ${fmt(total)} Fishing Locations - Fisch Guide`,
  description: `Complete Fisch location guide: ${fmt(total)} fishing spots with fish, weather, and details.`,
  author: { '@type': 'Organization', name: 'Codigos Gratis' },
  publisher: { '@type': 'Organization', name: 'Codigos Gratis' },
  mainEntityOfPage: new URL('/games/fisch/locations/', Astro.site).href,
};

const locItemListSchema = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: 'Fisch Fishing Locations',
  numberOfItems: total,
  itemListElement: regularLocs.slice(0, 10).map((l, i) => ({
    '@type': 'ListItem',
    position: i + 1,
    name: `${l.name} (${l.fishCount} fish)`,
  })),
};
---

<GameLayout
  title={`All ${fmt(total)} Locations - Fish & Guide | Fisch Roblox`}
  description={`Complete Fisch location guide: ${fmt(total)} fishing spots with available fish, weather, and details. Find where to catch any fish.`}
  game="Fisch"
  breadcrumbs={[{ label: 'Locations', href: '/games/fisch/locations/' }]}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(locItemListSchema)} />
  </Fragment>

  <FischHero title="FISHING LOCATIONS" subtitle={`${fmt(total)} locations to explore`} />

  <div class="container">
    <!-- SEARCH -->
    <div class="loc-search-wrap">
      <svg class="loc-search-ico" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input
        class="loc-search"
        type="text"
        placeholder="Search location..."
        id="loc-search"
        autocomplete="off"
      />
    </div>

    <!-- SORT CONTROLS -->
    <div class="loc-controls">
      <span class="loc-controls__count" id="loc-count">{fmt(total)} locations</span>
      <div class="loc-controls__btns">
        <button class="loc-sort-btn loc-sort-btn--active" data-sort="fish" type="button">By fish count</button>
        <button class="loc-sort-btn" data-sort="alpha" type="button">A–Z</button>
      </div>
    </div>

    <!-- REGULAR LOCATIONS -->
    {regularLocs.length > 0 && (
      <section class="loc-section">
        <h2 class="section-heading">Locations ({regularLocs.length})</h2>
        <div class="loc-list" id="loc-list-regular">
          {regularLocs.map(loc => {
            const sortedFish = [...loc.fish].sort((a, b) =>
              (RARITY_ORDER[a.rarity] ?? 99) - (RARITY_ORDER[b.rarity] ?? 99)
            );
            return (
              <div class="loc-card" data-name={loc.name.toLowerCase()} data-fish={loc.fishCount}>
                <button class="loc-card__header" type="button" aria-expanded="false">
                  <div class="loc-card__info">
                    <span class="loc-card__name">{loc.name}</span>
                    <div class="loc-card__meta">
                      <span class="loc-card__fish-count">{loc.fishCount} fish</span>
                      {loc.isPremium && <span class="loc-card__tag loc-card__tag--premium">Premium</span>}
                      {loc.isSeasonal && <span class="loc-card__tag loc-card__tag--seasonal">Seasonal</span>}
                      {loc.availableWeathers.length > 0 && loc.availableWeathers[0] !== 'Any' && (
                        <span class="loc-card__weather">{loc.availableWeathers.join(', ')}</span>
                      )}
                    </div>
                  </div>
                  <svg class="loc-card__chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div class="loc-card__panel">
                  {loc.description && <p class="loc-card__desc">{loc.description}</p>}
                  <div class="loc-card__fish-grid">
                    {sortedFish.map(f => {
                      const fishId = fishIdMap[f.name];
                      const color = RARITY_COLORS[f.rarity] || '#888';
                      return fishId ? (
                        <a href={`/games/fisch/fish/${fishId}/`} class="loc-fish" style={`--rc: ${color}`}>
                          <span class="loc-fish__name">{f.name}</span>
                          <span class="loc-fish__rarity">{f.rarity}</span>
                        </a>
                      ) : (
                        <span class="loc-fish loc-fish--nolink" style={`--rc: ${color}`}>
                          <span class="loc-fish__name">{f.name}</span>
                          <span class="loc-fish__rarity">{f.rarity}</span>
                        </span>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}

    <!-- EVENT LOCATIONS -->
    {eventLocs.length > 0 && (
      <section class="loc-section">
        <h2 class="section-heading">Event Locations ({eventLocs.length})</h2>
        <div class="loc-list" id="loc-list-event">
          {eventLocs.map(loc => {
            const sortedFish = [...loc.fish].sort((a, b) =>
              (RARITY_ORDER[a.rarity] ?? 99) - (RARITY_ORDER[b.rarity] ?? 99)
            );
            return (
              <div class="loc-card" data-name={loc.name.toLowerCase()} data-fish={loc.fishCount}>
                <button class="loc-card__header" type="button" aria-expanded="false">
                  <div class="loc-card__info">
                    <span class="loc-card__name">{loc.name}</span>
                    <div class="loc-card__meta">
                      <span class="loc-card__fish-count">{loc.fishCount} fish</span>
                      <span class="loc-card__tag loc-card__tag--event">Event</span>
                    </div>
                  </div>
                  <svg class="loc-card__chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div class="loc-card__panel">
                  {loc.description && <p class="loc-card__desc">{loc.description}</p>}
                  <div class="loc-card__fish-grid">
                    {sortedFish.map(f => {
                      const fishId = fishIdMap[f.name];
                      const color = RARITY_COLORS[f.rarity] || '#888';
                      return fishId ? (
                        <a href={`/games/fisch/fish/${fishId}/`} class="loc-fish" style={`--rc: ${color}`}>
                          <span class="loc-fish__name">{f.name}</span>
                          <span class="loc-fish__rarity">{f.rarity}</span>
                        </a>
                      ) : (
                        <span class="loc-fish loc-fish--nolink" style={`--rc: ${color}`}>
                          <span class="loc-fish__name">{f.name}</span>
                          <span class="loc-fish__rarity">{f.rarity}</span>
                        </span>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    )}
  </div>
</GameLayout>

<script is:inline>
(function() {
  // Accordion
  document.querySelectorAll('.loc-card__header').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var card = btn.closest('.loc-card');
      var isOpen = card.classList.toggle('loc-card--open');
      btn.setAttribute('aria-expanded', isOpen);
    });
  });

  // Search
  var searchInput = document.getElementById('loc-search');
  var countEl = document.getElementById('loc-count');
  var allCards = Array.from(document.querySelectorAll('.loc-card'));
  var totalCount = allCards.length;

  searchInput.addEventListener('input', function() {
    var q = searchInput.value.toLowerCase().trim();
    var visible = 0;
    allCards.forEach(function(card) {
      var name = card.getAttribute('data-name');
      var show = !q || name.indexOf(q) > -1;
      card.style.display = show ? '' : 'none';
      if (show) visible++;
    });
    countEl.textContent = visible === totalCount
      ? totalCount + ' locations'
      : visible + ' of ' + totalCount + ' locations';
  });

  // Sort
  var sortBtns = document.querySelectorAll('.loc-sort-btn');
  sortBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      sortBtns.forEach(function(b) { b.classList.remove('loc-sort-btn--active'); });
      btn.classList.add('loc-sort-btn--active');
      var sortType = btn.getAttribute('data-sort');
      document.querySelectorAll('.loc-list').forEach(function(list) {
        var cards = Array.from(list.querySelectorAll('.loc-card'));
        cards.sort(function(a, b) {
          if (sortType === 'alpha') {
            return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
          }
          return parseInt(b.getAttribute('data-fish')) - parseInt(a.getAttribute('data-fish'));
        });
        cards.forEach(function(card) { list.appendChild(card); });
      });
    });
  });
})();
</script>

<style>
  .section-heading {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  /* ============================================================
     SEARCH
     ============================================================ */

  .loc-search-wrap {
    position: relative;
    margin-bottom: 0.75rem;
  }

  .loc-search-ico {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-dim);
    pointer-events: none;
  }

  .loc-search {
    width: 100%;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.6rem 0.75rem 0.6rem 2.25rem;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .loc-search:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(6, 214, 160, 0.15);
  }

  .loc-search::placeholder {
    color: var(--text-dim);
  }

  /* ============================================================
     CONTROLS
     ============================================================ */

  .loc-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    gap: 0.75rem;
  }

  .loc-controls__count {
    font-size: 0.8rem;
    color: var(--text-dim);
    font-weight: 500;
  }

  .loc-controls__btns {
    display: flex;
    gap: 0.3rem;
  }

  .loc-sort-btn {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.35rem 0.65rem;
    color: var(--text-dim);
    font-family: var(--font-body);
    font-size: 0.78rem;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s, background 0.2s;
  }

  .loc-sort-btn:hover {
    border-color: rgba(6, 214, 160, 0.3);
    color: var(--text);
  }

  .loc-sort-btn--active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(6, 214, 160, 0.08);
  }

  /* ============================================================
     LOCATION SECTIONS
     ============================================================ */

  .loc-section {
    margin-bottom: 2rem;
  }

  .loc-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  /* ============================================================
     LOCATION CARD
     ============================================================ */

  .loc-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    transition: border-color 0.25s;
  }

  .loc-card--open {
    border-color: rgba(6, 214, 160, 0.3);
  }

  .loc-card__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    width: 100%;
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    cursor: pointer;
    text-align: left;
    font-family: var(--font-body);
    color: var(--text);
    transition: background 0.15s;
  }

  .loc-card__header:hover {
    background: rgba(6, 214, 160, 0.03);
  }

  .loc-card__info {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    min-width: 0;
  }

  .loc-card__name {
    font-weight: 600;
    font-size: 0.95rem;
    color: #fff;
  }

  .loc-card__meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.4rem;
  }

  .loc-card__fish-count {
    font-family: var(--font-display);
    font-size: 0.78rem;
    color: var(--accent);
    font-weight: 700;
  }

  .loc-card__tag {
    font-size: 0.65rem;
    font-weight: 600;
    padding: 0.1rem 0.4rem;
    border-radius: 9999px;
    border: 1px solid;
    letter-spacing: 0.3px;
  }

  .loc-card__tag--premium {
    color: #fbbf24;
    border-color: #fbbf2440;
    background: #fbbf2410;
  }

  .loc-card__tag--seasonal {
    color: #38bdf8;
    border-color: #38bdf840;
    background: #38bdf810;
  }

  .loc-card__tag--event {
    color: #c084fc;
    border-color: #c084fc40;
    background: #c084fc10;
  }

  .loc-card__weather {
    font-size: 0.72rem;
    color: var(--text-dim);
  }

  .loc-card__chevron {
    flex-shrink: 0;
    color: var(--text-dim);
    transition: transform 0.25s;
  }

  .loc-card--open .loc-card__chevron {
    transform: rotate(180deg);
  }

  /* Panel (accordion content) */

  .loc-card__panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .loc-card--open .loc-card__panel {
    max-height: 2000px;
  }

  .loc-card__desc {
    padding: 0 1rem 0.6rem;
    font-size: 0.82rem;
    color: var(--text-dim);
    line-height: 1.55;
    border-top: 1px solid var(--border);
    padding-top: 0.6rem;
    margin: 0 0.25rem;
  }

  .loc-card__fish-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    padding: 0.5rem 1rem 0.85rem;
  }

  /* No description + fish grid: add top border */
  .loc-card__desc + .loc-card__fish-grid {
    padding-top: 0;
  }

  .loc-card__panel > .loc-card__fish-grid:first-child {
    border-top: 1px solid var(--border);
    margin: 0 0.25rem;
    padding-top: 0.6rem;
  }

  /* ============================================================
     FISH CHIPS (inside location)
     ============================================================ */

  .loc-fish {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.55rem;
    background: color-mix(in srgb, var(--rc) 8%, transparent);
    border: 1px solid color-mix(in srgb, var(--rc) 25%, transparent);
    border-radius: 8px;
    font-size: 0.78rem;
    transition: border-color 0.2s, background 0.2s;
    cursor: pointer;
  }

  .loc-fish:hover {
    border-color: color-mix(in srgb, var(--rc) 50%, transparent);
    background: color-mix(in srgb, var(--rc) 14%, transparent);
  }

  .loc-fish--nolink {
    cursor: default;
  }

  .loc-fish__name {
    color: var(--text);
    font-weight: 500;
    white-space: nowrap;
  }

  .loc-fish__rarity {
    color: var(--rc);
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.3px;
    white-space: nowrap;
  }

  /* ============================================================
     RESPONSIVE
     ============================================================ */

  @media (max-width: 479px) {
    .loc-card__fish-grid {
      gap: 0.25rem;
      padding: 0.4rem 0.75rem 0.7rem;
    }
    .loc-fish {
      font-size: 0.72rem;
      padding: 0.2rem 0.45rem;
    }
    .loc-fish__rarity {
      display: none;
    }
  }
</style>
