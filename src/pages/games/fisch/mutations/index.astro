---
import GameLayout from '../../../../layouts/GameLayout.astro';
import FischHero from '../../../../components/FischHero.astro';
import MutationTable from '../../../../components/MutationTable.tsx';
import type { MutationRow } from '../../../../components/MutationTable.tsx';

import mutationsData from '../../../../data/games/fisch/mutations.json';

// Build rows for React
const rows: MutationRow[] = (mutationsData as any[]).map(m => ({
  id: m.id,
  name: m.name,
  multiplier: typeof m.multiplier === 'number' ? m.multiplier : m.multiplier.max,
  multiplierMin: typeof m.multiplier === 'object' ? m.multiplier.min : null,
  category: m.category,
  appraisable: m.appraisable,
  wikiNotes: m.wikiNotes,
  obtainMethod: m.obtainMethod,
}));

const categories = [...new Set(rows.map(r => r.category))].sort();
const maxMult = Math.max(...rows.map(r => r.multiplier));
const total = rows.length;
const fmt = (n: number) => n.toLocaleString('en-US');

// Top 10 by multiplier for the intro table
const top10 = [...rows].sort((a, b) => b.multiplier - a.multiplier).slice(0, 10);

// Category counts
const catCounts: Record<string, number> = {};
rows.forEach(r => { catCounts[r.category] = (catCounts[r.category] || 0) + 1; });

// Schema.org
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: `All ${fmt(total)} Mutations & Multipliers - Fisch Guide`,
  description: `Complete Fisch mutations guide: ${fmt(total)} mutations sorted by multiplier.`,
  author: { '@type': 'Organization', name: 'Codigos Gratis' },
  publisher: { '@type': 'Organization', name: 'Codigos Gratis' },
  mainEntityOfPage: new URL('/games/fisch/mutations/', Astro.site).href,
};

const itemListSchema = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: 'Fisch Mutations',
  numberOfItems: total,
  itemListElement: top10.map((m, i) => ({
    '@type': 'ListItem',
    position: i + 1,
    name: `${m.name} (${m.multiplier}x)`,
  })),
};
---

<GameLayout
  title={`All ${fmt(total)} Mutations & Multipliers - Fisch Guide`}
  description={`Complete Fisch mutations guide: ${fmt(total)} mutations sorted by multiplier. Learn how mutations work, which are the most valuable, and how to obtain them.`}
  game="Fisch"
  breadcrumbs={[{ label: 'Mutations', href: '/games/fisch/mutations/' }]}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />
  </Fragment>

  <FischHero title="MUTATIONS GUIDE" subtitle={`${fmt(total)} genetic modifiers documented`} />

  <div class="container">
    <!-- EXPLAINER -->
    <section class="explainer">
      <div class="explainer__card">
        <h2 class="explainer__title">What are Mutations?</h2>
        <p class="explainer__text">
          Mutations are special modifiers that can appear on fish when you catch them.
          Each mutation has a <strong>multiplier</strong> that changes the fish's selling value.
          A fish with a high-value mutation can be worth many times more than the same fish without one.
        </p>
      </div>

      <div class="explainer__card">
        <h2 class="explainer__title">How Mutation Value Works</h2>
        <div class="formula">
          <span class="formula__part">Base Value (C$/kg)</span>
          <span class="formula__op">Ã—</span>
          <span class="formula__part">Weight (kg)</span>
          <span class="formula__op">Ã—</span>
          <span class="formula__part formula__part--accent">Mutation Multiplier</span>
          <span class="formula__op">=</span>
          <span class="formula__part formula__part--result">Final Value</span>
        </div>
        <p class="explainer__example">
          Example: A fish worth 500 C$/kg, weighing 100 kg, with an <strong>Ascended (9.9Ã—)</strong> mutation
          = 500 Ã— 100 Ã— 9.9 = <strong>495,000 C$</strong>
        </p>
      </div>
    </section>

    <!-- CTA -->
    <div class="cta-banner">
      <a href="/games/fisch/calculator/" class="cta-banner__link">
        <span class="cta-banner__icon">ðŸ”„</span>
        <span class="cta-banner__text">
          <strong>Trade Calculator</strong> â€” Check if your mutated fish trade is a Win, Fair, or Lose
        </span>
        <span class="cta-banner__arrow">&rarr;</span>
      </a>
    </div>

    <!-- CATEGORY PILLS -->
    <section class="cats">
      <h2 class="section-heading">Categories</h2>
      <div class="cats__row">
        <div class="cat-pill cat-pill--standard">
          <span class="cat-pill__name">Standard</span>
          <span class="cat-pill__count">{catCounts.standard || 0}</span>
        </div>
        <div class="cat-pill cat-pill--limited">
          <span class="cat-pill__name">Limited</span>
          <span class="cat-pill__count">{catCounts.limited || 0}</span>
        </div>
        <div class="cat-pill cat-pill--admin">
          <span class="cat-pill__name">Admin</span>
          <span class="cat-pill__count">{catCounts.admin || 0}</span>
        </div>
        <div class="cat-pill cat-pill--attribute">
          <span class="cat-pill__name">Attribute</span>
          <span class="cat-pill__count">{catCounts.attribute || 0}</span>
        </div>
        <div class="cat-pill cat-pill--unobtainable">
          <span class="cat-pill__name">Unobtainable</span>
          <span class="cat-pill__count">{catCounts.unobtainable || 0}</span>
        </div>
      </div>
    </section>

    <!-- TOP 10 TABLE -->
    <section class="top10">
      <h2 class="section-heading">Top 10 Most Valuable Mutations</h2>
      <div class="top10__wrap">
        <table class="top10__table">
          <thead>
            <tr>
              <th class="top10__th">#</th>
              <th class="top10__th">Name</th>
              <th class="top10__th">Multiplier</th>
              <th class="top10__th top10__th--cat">Category</th>
              <th class="top10__th top10__th--notes">How to Obtain</th>
            </tr>
          </thead>
          <tbody>
            {top10.map((m, i) => (
              <tr class="top10__row">
                <td class="top10__td top10__td--rank">{i + 1}</td>
                <td class="top10__td top10__td--name">{m.name}</td>
                <td class="top10__td top10__td--mult">{m.multiplier}Ã—</td>
                <td class="top10__td top10__td--cat">{m.category}</td>
                <td class="top10__td top10__td--notes">{m.wikiNotes || m.obtainMethod || 'â€”'}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>

    <!-- FULL LIST (React island) -->
    <section class="full-list">
      <h2 class="section-heading">All Mutations</h2>
      <MutationTable
        client:visible
        mutations={rows}
        categories={categories}
        maxMult={maxMult}
      />
    </section>
  </div>
</GameLayout>

<style>
  .section-heading {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  /* ============================================================
     EXPLAINER
     ============================================================ */

  .explainer {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding-bottom: 1.5rem;
  }

  .explainer__card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.15rem 1.25rem;
  }

  .explainer__title {
    font-family: var(--font-display);
    font-size: 1.05rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 0.5rem;
  }

  .explainer__text {
    font-size: 0.9rem;
    color: var(--text-dim);
    line-height: 1.65;
  }

  .explainer__text strong {
    color: var(--text);
  }

  .formula {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    margin: 0.75rem 0;
  }

  .formula__part {
    padding: 0.35rem 0.7rem;
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
  }

  .formula__part--accent {
    border-color: rgba(6, 214, 160, 0.3);
    color: var(--accent);
  }

  .formula__part--result {
    border-color: rgba(244, 63, 94, 0.3);
    color: #fb7185;
  }

  .formula__op {
    font-family: var(--font-display);
    font-size: 1rem;
    color: var(--text-dim);
    font-weight: 700;
  }

  .explainer__example {
    font-size: 0.85rem;
    color: var(--text-dim);
    line-height: 1.6;
  }

  .explainer__example strong {
    color: var(--accent);
  }

  @media (min-width: 640px) {
    .explainer {
      flex-direction: row;
    }
    .explainer__card {
      flex: 1;
    }
  }

  /* ============================================================
     CATEGORY PILLS
     ============================================================ */

  .cats {
    padding-bottom: 1.5rem;
  }

  .cats__row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .cat-pill {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.8rem;
    border: 1px solid;
    border-radius: 9999px;
    font-size: 0.82rem;
    font-weight: 600;
  }

  .cat-pill__count {
    font-family: var(--font-display);
    font-size: 0.75rem;
    opacity: 0.7;
  }

  .cat-pill--standard  { border-color: #06d6a040; color: #06d6a0; background: #06d6a010; }
  .cat-pill--limited   { border-color: #ef444440; color: #f87171; background: #ef444410; }
  .cat-pill--admin     { border-color: #a855f740; color: #c084fc; background: #a855f710; }
  .cat-pill--attribute { border-color: #0ea5e940; color: #38bdf8; background: #0ea5e910; }
  .cat-pill--unobtainable { border-color: #71717a40; color: #a1a1aa; background: #71717a10; }

  /* ============================================================
     TOP 10 TABLE
     ============================================================ */

  .top10 {
    padding-bottom: 1.5rem;
  }

  .top10__wrap {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--bg-card);
  }

  .top10__table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .top10__th {
    padding: 0.6rem 0.75rem;
    text-align: left;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  .top10__row:not(:last-child) .top10__td {
    border-bottom: 1px solid rgba(30, 41, 59, 0.5);
  }

  .top10__td {
    padding: 0.55rem 0.75rem;
    vertical-align: middle;
  }

  .top10__td--rank {
    font-family: var(--font-display);
    font-weight: 700;
    color: var(--text-dim);
    width: 2rem;
    text-align: center;
  }

  .top10__td--name {
    font-weight: 600;
    color: #fff;
    white-space: nowrap;
  }

  .top10__td--mult {
    font-family: var(--font-display);
    font-weight: 700;
    color: #f43f5e;
    white-space: nowrap;
  }

  .top10__td--cat {
    font-size: 0.8rem;
    color: var(--text-dim);
    white-space: nowrap;
  }

  .top10__td--notes {
    font-size: 0.8rem;
    color: var(--text-dim);
    line-height: 1.45;
    max-width: 320px;
  }

  @media (max-width: 639px) {
    .top10__th--cat,
    .top10__td--cat,
    .top10__th--notes,
    .top10__td--notes {
      display: none;
    }
  }

  /* ============================================================
     FULL LIST SECTION
     ============================================================ */

  .full-list {
    padding-bottom: 1rem;
  }

  /* ---- React component styles (MutationTable) ---- */

  /* Filters */
  :global(.mt__filters) {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    margin-bottom: 0.75rem;
  }

  :global(.mt__search-wrap) {
    position: relative;
    display: flex;
    align-items: center;
  }

  :global(.mt__search-ico) {
    position: absolute;
    left: 0.75rem;
    color: var(--text-dim);
    pointer-events: none;
  }

  :global(.mt__search) {
    width: 100%;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.6rem 0.75rem 0.6rem 2.25rem;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  :global(.mt__search:focus) {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(6, 214, 160, 0.15);
  }

  :global(.mt__search::placeholder) {
    color: var(--text-dim);
  }

  :global(.mt__filter-row) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }

  :global(.mt__select) {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.45rem 0.7rem;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 0.8rem;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
  }

  :global(.mt__select:focus) {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(6, 214, 160, 0.15);
  }

  :global(.mt__select option) {
    background: var(--bg-card);
    color: var(--text);
  }

  :global(.mt__toggle-label) {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.8rem;
    color: var(--text-dim);
    cursor: pointer;
    white-space: nowrap;
  }

  :global(.mt__toggle-label input) {
    accent-color: var(--accent);
    width: 14px;
    height: 14px;
    cursor: pointer;
  }

  :global(.mt__clear) {
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.4rem 0.65rem;
    color: var(--accent-hot);
    font-size: 0.78rem;
    cursor: pointer;
    font-family: var(--font-body);
    transition: border-color 0.2s, background 0.2s;
  }

  :global(.mt__clear:hover) {
    border-color: var(--accent-hot);
    background: rgba(255, 107, 107, 0.08);
  }

  /* Count */
  :global(.mt__count) {
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  /* List */
  :global(.mt__list) {
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--bg-card);
    overflow: hidden;
  }

  :global(.mt__hdr-row) {
    display: none;
  }

  @media (min-width: 640px) {
    :global(.mt__hdr-row) {
      display: grid;
      grid-template-columns: 1fr 160px 110px 90px 28px;
      gap: 0.5rem;
      align-items: center;
      padding: 0.6rem 1rem;
      border-bottom: 1px solid var(--border);
    }
  }

  :global(.mt__hdr) {
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    user-select: none;
    transition: color 0.2s;
    white-space: nowrap;
  }

  :global(.mt__hdr:hover) {
    color: var(--accent);
  }

  /* Card item */
  :global(.mt__card) {
    border-bottom: 1px solid rgba(30, 41, 59, 0.5);
  }

  :global(.mt__card:last-child) {
    border-bottom: none;
  }

  :global(.mt__card-main) {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.5rem 0.75rem;
    align-items: center;
    padding: 0.65rem 1rem;
    cursor: pointer;
    transition: background 0.15s;
  }

  :global(.mt__card-main:hover) {
    background: rgba(6, 214, 160, 0.03);
  }

  @media (min-width: 640px) {
    :global(.mt__card-main) {
      grid-template-columns: 1fr 160px 110px 90px 28px;
    }
  }

  /* Name column */
  :global(.mt__name-col) {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  :global(.mt__name) {
    font-weight: 600;
    color: #fff;
    font-size: 0.9rem;
  }

  :global(.mt__range) {
    font-size: 0.72rem;
    color: var(--text-dim);
    font-family: var(--font-display);
  }

  /* Multiplier column */
  :global(.mt__mult-col) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  :global(.mt__mult-val) {
    font-family: var(--font-display);
    font-size: 0.95rem;
    font-weight: 700;
    color: #fff;
    min-width: 3rem;
    text-align: right;
  }

  :global(.mt__bar) {
    flex: 1;
    height: 6px;
    background: rgba(255, 255, 255, 0.06);
    border-radius: 3px;
    overflow: hidden;
    min-width: 40px;
  }

  :global(.mt__bar-fill) {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s;
  }

  /* Hide bar on mobile to save space */
  @media (max-width: 639px) {
    :global(.mt__bar) {
      display: none;
    }
  }

  /* Category badge */
  :global(.mt__cat-badge) {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border: 1px solid;
    border-radius: 9999px;
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.3px;
    white-space: nowrap;
    text-align: center;
  }

  /* Appraisable */
  :global(.mt__appr) {
    font-size: 0.78rem;
    text-align: center;
  }

  :global(.mt__appr-yes) {
    color: var(--accent);
    font-weight: 600;
  }

  :global(.mt__appr-no) {
    color: var(--text-dim);
  }

  :global(.mt__appr-unk) {
    color: var(--text-dim);
    opacity: 0.5;
  }

  /* Hide appraisable on mobile */
  @media (max-width: 639px) {
    :global(.mt__hdr--appr),
    :global(.mt__appr) {
      display: none;
    }
    :global(.mt__cat-badge) {
      display: none;
    }
  }

  /* Chevron */
  :global(.mt__chevron) {
    color: var(--text-dim);
    transition: transform 0.25s;
    flex-shrink: 0;
    justify-self: end;
  }

  :global(.mt__chevron--open) {
    transform: rotate(180deg);
  }

  /* Notes */
  :global(.mt__notes) {
    padding: 0 1rem 0.75rem 1rem;
    font-size: 0.82rem;
    color: var(--text-dim);
    line-height: 1.55;
    border-top: 1px solid rgba(30, 41, 59, 0.3);
    padding-top: 0.6rem;
    margin: 0 0.5rem;
  }

  /* Empty */
  :global(.mt__empty) {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-dim);
    font-size: 0.9rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }

  /* Pagination */
  :global(.mt__pag) {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem 0 0.5rem;
  }

  :global(.mt__pag-btn) {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.4rem 0.65rem;
    color: var(--text);
    font-size: 0.85rem;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    font-family: var(--font-body);
  }

  :global(.mt__pag-btn:hover:not(:disabled)) {
    border-color: var(--accent);
    background: rgba(6, 214, 160, 0.06);
  }

  :global(.mt__pag-btn:disabled) {
    opacity: 0.3;
    cursor: default;
  }

  :global(.mt__pag-info) {
    font-size: 0.82rem;
    color: var(--text-dim);
    font-family: var(--font-display);
    min-width: 4rem;
    text-align: center;
  }

  /* ============================================================
     CTA BANNER
     ============================================================ */

  .cta-banner {
    margin-bottom: 1.5rem;
  }

  .cta-banner__link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.85rem 1.1rem;
    background: rgba(6, 214, 160, 0.06);
    border: 1px solid rgba(6, 214, 160, 0.25);
    border-radius: 12px;
    transition: border-color 0.2s, background 0.2s;
  }

  .cta-banner__link:hover {
    border-color: rgba(6, 214, 160, 0.5);
    background: rgba(6, 214, 160, 0.1);
  }

  .cta-banner__icon {
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  .cta-banner__text {
    flex: 1;
    font-size: 0.88rem;
    color: var(--text-dim);
    line-height: 1.4;
  }

  .cta-banner__text strong {
    color: var(--accent);
  }

  .cta-banner__arrow {
    font-size: 1.1rem;
    color: var(--accent);
    flex-shrink: 0;
  }
</style>
