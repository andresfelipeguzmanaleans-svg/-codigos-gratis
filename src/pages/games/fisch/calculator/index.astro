---
import GameLayout from '../../../../layouts/GameLayout.astro';
import TradeCalc from '../../../../components/TradeCalc.tsx';
import type { SlimFish, SlimMutation } from '../../../../components/TradeCalc.tsx';

import fishData from '../../../../data/games/fisch/fish.json';
import mutationsData from '../../../../data/games/fisch/mutations.json';

// ---------- Slim fish data ----------
const fish: SlimFish[] = (fishData as any[])
  .filter(f => f.id && f.name && f.baseValue != null && f.baseValue > 0)
  .map(f => ({
    id: f.id,
    name: f.name,
    rarity: f.rarity,
    baseValue: f.baseValue,
    baseWeight: f.baseWeight ?? 1,
    weightMin: f.weightRange?.min ?? f.baseWeight ?? 1,
    weightMax: f.weightRange?.max ?? f.baseWeight ?? 1,
  }));

// ---------- Slim mutations data ----------
const mutations: SlimMutation[] = (mutationsData as any[]).map(m => ({
  id: m.id,
  name: m.name,
  multiplier: typeof m.multiplier === 'number' ? m.multiplier : m.multiplier?.max ?? 1,
  category: m.category,
}));

const fmt = (n: number) => n.toLocaleString('en-US');

// Schema.org
const webAppSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebApplication',
  name: 'Fisch Trade Calculator',
  description: 'Check if your Fisch trade is fair. Calculate fish values with mutations and weight.',
  url: new URL('/games/fisch/calculator/', Astro.site).href,
  applicationCategory: 'GameApplication',
  operatingSystem: 'Any',
  offers: { '@type': 'Offer', price: '0', priceCurrency: 'USD' },
  publisher: { '@type': 'Organization', name: 'Codigos Gratis' },
};
---

<GameLayout
  title="Fisch Trade Calculator - Win/Fair/Lose Checker"
  description={`Check if your Fisch trade is fair. Calculate fish values with mutations and weight for ${fmt(fish.length)} fish. Free W/F/L trade calculator.`}
  game="Fisch"
  breadcrumbs={[{ label: 'Trade Calculator', href: '/games/fisch/calculator/' }]}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(webAppSchema)} />
  </Fragment>

  <div class="container">
    <header class="page-hdr">
      <h1 class="page-hdr__title">Trade Calculator</h1>
      <p class="page-hdr__sub">Add fish to both sides and check if the trade is a Win, Fair, or Lose</p>
    </header>

    <!-- HOW IT WORKS -->
    <section class="tc-explainer">
      <div class="tc-explainer__card">
        <h2 class="tc-explainer__title">How it Works</h2>
        <div class="formula">
          <span class="formula__part">Base Value (C$/kg)</span>
          <span class="formula__op">&times;</span>
          <span class="formula__part">Weight (kg)</span>
          <span class="formula__op">&times;</span>
          <span class="formula__part formula__part--accent">Mutation (x)</span>
          <span class="formula__op">=</span>
          <span class="formula__part formula__part--result">Fish Value</span>
        </div>
        <p class="tc-explainer__text">
          Each fish's value = base value &times; weight &times; mutation multiplier.
          A trade is <strong class="tc-explainer__win">WIN</strong> if you gain &gt;10%,
          <strong class="tc-explainer__fair">FAIR</strong> if within &plusmn;10%, or
          <strong class="tc-explainer__lose">LOSE</strong> if you lose &gt;10%.
        </p>
      </div>
    </section>

    <!-- REACT ISLAND -->
    <section class="tc-section">
      <TradeCalc
        client:load
        fish={fish}
        mutations={mutations}
      />
    </section>

    <!-- RELATED LINKS -->
    <section class="calc-links">
      <h2 class="calc-links__title">Related Tools & Data</h2>
      <div class="calc-links__grid">
        <a href="/games/fisch/values/" class="calc-link-card">
          <span class="calc-link-card__icon">üí∞</span>
          <strong>Value List</strong>
          <span class="calc-link-card__desc">All fish prices and estimated values</span>
        </a>
        <a href="/games/fisch/mutations/" class="calc-link-card">
          <span class="calc-link-card__icon">üß¨</span>
          <strong>Mutations Guide</strong>
          <span class="calc-link-card__desc">All multipliers and how to obtain them</span>
        </a>
        <a href="/games/fisch/fish/" class="calc-link-card">
          <span class="calc-link-card__icon">üêü</span>
          <strong>Fish Database</strong>
          <span class="calc-link-card__desc">Full database with locations and stats</span>
        </a>
        <a href="/games/fisch/rods/" class="calc-link-card">
          <span class="calc-link-card__icon">üé£</span>
          <strong>Fishing Rods</strong>
          <span class="calc-link-card__desc">Compare rods by luck, control, and more</span>
        </a>
      </div>
    </section>
  </div>
</GameLayout>

<style>
  /* ============================================================
     PAGE HEADER
     ============================================================ */

  .page-hdr {
    padding: 0.5rem 0 1.25rem;
  }

  .page-hdr__title {
    font-family: var(--font-display);
    font-size: 1.75rem;
    font-weight: 700;
    color: #fff;
  }

  .page-hdr__sub {
    margin-top: 0.25rem;
    font-size: 0.9rem;
    color: var(--text-dim);
  }

  @media (min-width: 768px) {
    .page-hdr__title { font-size: 2rem; }
  }

  /* ============================================================
     EXPLAINER
     ============================================================ */

  .tc-explainer {
    padding-bottom: 1.5rem;
  }

  .tc-explainer__card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
  }

  .tc-explainer__title {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 0.75rem;
  }

  .formula {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 0.75rem;
  }

  .formula__part {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.35rem 0.65rem;
    font-family: var(--font-display);
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text);
  }

  .formula__part--accent {
    color: var(--accent);
    border-color: rgba(6, 214, 160, 0.3);
    background: rgba(6, 214, 160, 0.08);
  }

  .formula__part--result {
    color: #fbbf24;
    border-color: rgba(251, 191, 36, 0.3);
    background: rgba(251, 191, 36, 0.08);
  }

  .formula__op {
    font-family: var(--font-display);
    font-weight: 700;
    color: var(--text-dim);
    font-size: 0.9rem;
  }

  .tc-explainer__text {
    font-size: 0.85rem;
    color: var(--text-dim);
    line-height: 1.6;
  }

  .tc-explainer__win { color: var(--accent); }
  .tc-explainer__fair { color: var(--accent-warn); }
  .tc-explainer__lose { color: var(--accent-hot); }

  .tc-section {
    padding-bottom: 2rem;
  }

  /* ============================================================
     REACT COMPONENT: TradeCalc  (.tc__*)
     ============================================================ */

  /* --- Actions bar --- */
  :global(.tc__actions) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin-bottom: 1rem;
  }

  :global(.tc__action-btn) {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.5rem 0.85rem;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 0.82rem;
    font-weight: 500;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
  }

  :global(.tc__action-btn:hover) {
    border-color: var(--accent);
    background: rgba(6, 214, 160, 0.06);
  }

  :global(.tc__action-btn--danger:hover) {
    border-color: var(--accent-hot);
    background: rgba(255, 107, 107, 0.06);
    color: var(--accent-hot);
  }

  /* --- Columns layout --- */
  :global(.tc__columns) {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 0.75rem;
    align-items: start;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 767px) {
    :global(.tc__columns) {
      grid-template-columns: 1fr;
    }
  }

  :global(.tc__column) {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
  }

  :global(.tc__vs) {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-dim);
    align-self: center;
    padding: 0 0.25rem;
    text-align: center;
  }

  @media (max-width: 767px) {
    :global(.tc__vs) {
      padding: 0.25rem 0;
    }
  }

  /* --- Column titles --- */
  :global(.tc__col-title) {
    font-family: var(--font-display);
    font-size: 0.95rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border);
    text-align: center;
  }

  :global(.tc__col-title--yours) {
    color: var(--accent);
    border-bottom-color: rgba(6, 214, 160, 0.3);
  }

  :global(.tc__col-title--theirs) {
    color: #818cf8;
    border-bottom-color: rgba(129, 140, 248, 0.3);
  }

  /* --- Trade entry card --- */
  :global(.tc__entry) {
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(30, 41, 59, 0.5);
  }

  :global(.tc__entry:last-of-type) {
    border-bottom: none;
  }

  :global(.tc__entry-top) {
    display: flex;
    gap: 0.4rem;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  :global(.tc__entry-remove) {
    flex-shrink: 0;
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dim);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s, background 0.2s;
  }

  :global(.tc__entry-remove:hover) {
    border-color: var(--accent-hot);
    color: var(--accent-hot);
    background: rgba(255, 107, 107, 0.08);
  }

  :global(.tc__entry-fields) {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
  }

  @media (max-width: 479px) {
    :global(.tc__entry-fields) {
      grid-template-columns: 1fr;
    }
  }

  :global(.tc__field) {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  :global(.tc__field-label) {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  :global(.tc__field-input),
  :global(.tc__field-select) {
    width: 100%;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.45rem 0.6rem;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  :global(.tc__field-input:focus),
  :global(.tc__field-select:focus) {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(6, 214, 160, 0.12);
  }

  :global(.tc__field-input::placeholder) {
    color: var(--text-dim);
    font-size: 0.78rem;
  }

  :global(.tc__field-select) {
    cursor: pointer;
    appearance: auto;
  }

  :global(.tc__field-select option) {
    background: var(--bg-deep);
    color: var(--text);
  }

  :global(.tc__entry-value) {
    margin-top: 0.4rem;
    font-size: 0.82rem;
    color: var(--text-dim);
    text-align: right;
  }

  :global(.tc__entry-value-num) {
    font-family: var(--font-display);
    font-weight: 700;
    color: var(--accent);
  }

  /* --- Fish search dropdown --- */
  :global(.tc__fish-search) {
    position: relative;
    flex: 1;
    min-width: 0;
  }

  :global(.tc__fish-input) {
    width: 100%;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.45rem 0.6rem;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  :global(.tc__fish-input:focus) {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(6, 214, 160, 0.12);
  }

  :global(.tc__fish-input::placeholder) {
    color: var(--text-dim);
  }

  :global(.tc__fish-dropdown) {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 50;
    margin-top: 4px;
    background: var(--bg-card);
    border: 1px solid var(--accent);
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    max-height: 220px;
    overflow-y: auto;
    overscroll-behavior: contain;
  }

  :global(.tc__fish-option) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.45rem 0.65rem;
    cursor: pointer;
    transition: background 0.1s;
    font-size: 0.82rem;
  }

  :global(.tc__fish-option:hover) {
    background: rgba(6, 214, 160, 0.08);
  }

  :global(.tc__fish-option--sel) {
    background: rgba(6, 214, 160, 0.12);
  }

  :global(.tc__fish-dot) {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  :global(.tc__fish-option-name) {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text);
    font-weight: 500;
  }

  :global(.tc__fish-option-val) {
    flex-shrink: 0;
    font-family: var(--font-display);
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-dim);
  }

  :global(.tc__fish-no-match) {
    padding: 0.75rem;
    text-align: center;
    color: var(--text-dim);
    font-size: 0.82rem;
  }

  /* --- Add fish button --- */
  :global(.tc__add-btn) {
    display: block;
    width: 100%;
    margin-top: 0.5rem;
    background: none;
    border: 1px dashed var(--border);
    border-radius: 8px;
    padding: 0.45rem;
    color: var(--text-dim);
    font-family: var(--font-body);
    font-size: 0.82rem;
    font-weight: 500;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
  }

  :global(.tc__add-btn:hover) {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* --- Side total --- */
  :global(.tc__side-total) {
    margin-top: 0.75rem;
    padding-top: 0.65rem;
    border-top: 2px solid var(--border);
    font-size: 0.9rem;
    color: var(--text-dim);
    text-align: right;
    font-weight: 500;
  }

  :global(.tc__side-total-val) {
    font-family: var(--font-display);
    font-weight: 700;
    color: #fff;
    font-size: 1.05rem;
  }

  /* --- Result section --- */
  :global(.tc__result) {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1.5rem;
  }

  :global(.tc__result--win) {
    border-color: rgba(6, 214, 160, 0.4);
    background: rgba(6, 214, 160, 0.06);
  }

  :global(.tc__result--fair) {
    border-color: rgba(255, 209, 102, 0.4);
    background: rgba(255, 209, 102, 0.06);
  }

  :global(.tc__result--lose) {
    border-color: rgba(255, 107, 107, 0.4);
    background: rgba(255, 107, 107, 0.06);
  }

  :global(.tc__result-badge) {
    font-family: var(--font-display);
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.35rem;
  }

  :global(.tc__result--win .tc__result-badge) { color: var(--accent); }
  :global(.tc__result--fair .tc__result-badge) { color: var(--accent-warn); }
  :global(.tc__result--lose .tc__result-badge) { color: var(--accent-hot); }

  :global(.tc__result-diff) {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.5rem;
  }

  :global(.tc__result-vals) {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    font-size: 0.82rem;
    color: var(--text-dim);
    margin-bottom: 1rem;
  }

  /* --- Proportion bar --- */
  :global(.tc__bar) {
    display: flex;
    height: 28px;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 0.35rem;
  }

  :global(.tc__bar-yours) {
    background: rgba(6, 214, 160, 0.35);
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 0;
    transition: width 0.3s;
  }

  :global(.tc__bar-theirs) {
    background: rgba(129, 140, 248, 0.35);
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 0;
    transition: width 0.3s;
  }

  :global(.tc__bar-label) {
    font-family: var(--font-display);
    font-size: 0.68rem;
    font-weight: 700;
    color: #fff;
    white-space: nowrap;
    padding: 0 0.4rem;
  }

  :global(.tc__bar-legend) {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    color: var(--text-dim);
    margin-bottom: 1rem;
  }

  :global(.tc__bar-legend-yours) {
    color: var(--accent);
    font-weight: 600;
  }

  :global(.tc__bar-legend-theirs) {
    color: #818cf8;
    font-weight: 600;
  }

  :global(.tc__save-btn) {
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.4rem 1rem;
    color: var(--text-dim);
    font-family: var(--font-body);
    font-size: 0.78rem;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
  }

  :global(.tc__save-btn:hover) {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* --- History --- */
  :global(.tc__history) {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
  }

  :global(.tc__history-title) {
    font-family: var(--font-display);
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.65rem;
  }

  :global(.tc__history-row) {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.45rem 0.5rem;
    border-left: 3px solid var(--border);
    border-radius: 0 6px 6px 0;
    margin-bottom: 0.35rem;
    font-size: 0.82rem;
  }

  :global(.tc__history-row--win) { border-left-color: var(--accent); }
  :global(.tc__history-row--fair) { border-left-color: var(--accent-warn); }
  :global(.tc__history-row--lose) { border-left-color: var(--accent-hot); }

  :global(.tc__history-badge) {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 0.72rem;
    padding: 0.15rem 0.45rem;
    border-radius: 4px;
    flex-shrink: 0;
  }

  :global(.tc__history-badge--win) {
    color: var(--accent);
    background: rgba(6, 214, 160, 0.12);
  }

  :global(.tc__history-badge--fair) {
    color: var(--accent-warn);
    background: rgba(255, 209, 102, 0.12);
  }

  :global(.tc__history-badge--lose) {
    color: var(--accent-hot);
    background: rgba(255, 107, 107, 0.12);
  }

  :global(.tc__history-vals) {
    flex: 1;
    color: var(--text-dim);
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  :global(.tc__history-diff) {
    font-family: var(--font-display);
    font-weight: 700;
    color: var(--text);
    flex-shrink: 0;
  }

  /* ============================================================
     RELATED LINKS
     ============================================================ */

  .calc-links {
    padding-bottom: 2rem;
  }

  .calc-links__title {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.75rem;
  }

  .calc-links__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.6rem;
  }

  @media (min-width: 768px) {
    .calc-links__grid { grid-template-columns: repeat(4, 1fr); }
  }

  .calc-link-card {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.85rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    transition: border-color 0.2s, transform 0.2s;
  }

  .calc-link-card:hover {
    border-color: rgba(6, 214, 160, 0.35);
    transform: translateY(-2px);
  }

  .calc-link-card__icon {
    font-size: 1.25rem;
    margin-bottom: 0.15rem;
  }

  .calc-link-card strong {
    font-size: 0.88rem;
    color: #fff;
  }

  .calc-link-card__desc {
    font-size: 0.75rem;
    color: var(--text-dim);
    line-height: 1.4;
  }
</style>
