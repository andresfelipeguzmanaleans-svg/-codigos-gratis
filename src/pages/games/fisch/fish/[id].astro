---
import GameLayout from '../../../../layouts/GameLayout.astro';
import FischHero from '../../../../components/FischHero.astro';
import FishValueCalc from '../../../../components/FishValueCalc.tsx';

import fishData from '../../../../data/games/fisch/fish.json';
import mutationsData from '../../../../data/games/fisch/mutations.json';
import valuesData from '../../../../data/games/fisch/values.json';

// ---------- Types ----------

interface Fish {
  id: string;
  name: string;
  rarity: string;
  sea: string | null;
  location: string | null;
  sublocation: string | null;
  sources: string[];
  xp: number | null;
  weather: string[];
  time: string | null;
  season: string[];
  bait: string[];
  baseWeight: number | null;
  baseValue: number | null;
  weightRange: { min: number; max: number } | null;
  baseChance: number | null;
  baseResil: number | null;
  event: string | null;
  description: string | null;
  image: string | null;
  imageUrl: string | null;
}

interface Mutation {
  id: string;
  name: string;
  multiplier: number | { min: number; max: number };
}

interface ValueItem {
  itemId: string;
  name: string;
  basePrice: number;
  estimatedValue: { min: number; max: number } | null;
  baseCatchRate: number | null;
}

// ---------- Static paths ----------

export function getStaticPaths() {
  return (fishData as Fish[])
    .filter(f => f.id && f.name)
    .map(fish => ({
      params: { id: fish.id },
      props: { fish },
    }));
}

const { fish } = Astro.props as { fish: Fish };

// ---------- Derived data ----------

const tradingValue = (valuesData.items as ValueItem[]).find(
  v => v.itemId === fish.id,
);

const sameTier = (fishData as Fish[])
  .filter(f => f.rarity === fish.rarity && f.id !== fish.id && f.id && f.name);
// Deterministic shuffle by id hash
const shuffled = sameTier
  .map(f => ({ f, k: f.id.split('').reduce((a, c) => a + c.charCodeAt(0), 0) }))
  .sort((a, b) => a.k - b.k)
  .map(x => x.f);
const related = shuffled.slice(0, 10);

const fmt = (n: number) => n.toLocaleString('en-US');

const fmtC = (n: number): string => {
  if (n >= 1e12) return `${(n / 1e12).toFixed(2)}T`;
  if (n >= 1e9) return `${(n / 1e9).toFixed(2)}B`;
  if (n >= 1e6) return `${(n / 1e6).toFixed(2)}M`;
  if (n >= 1e3) return `${(n / 1e3).toFixed(1)}K`;
  return fmt(n);
};

// Meta
const valueStr = fish.baseValue ? `${fmt(fish.baseValue)} C$/kg` : 'unknown value';
const weightStr = fish.weightRange
  ? `${fmt(fish.weightRange.min)}-${fmt(fish.weightRange.max)} kg`
  : 'unknown weight';
const metaDesc = `Everything about ${fish.name} in Fisch Roblox: catch location, value (${valueStr}), weight (${weightStr}), mutations, and more.`;

// Rarity color map
const rarityColors: Record<string, { bg: string; border: string; text: string }> = {
  'Trash':          { bg: '#71717a20', border: '#71717a', text: '#a1a1aa' },
  'Common':         { bg: '#9ca3af20', border: '#9ca3af', text: '#d1d5db' },
  'Uncommon':       { bg: '#22c55e18', border: '#22c55e', text: '#4ade80' },
  'Unusual':        { bg: '#34d39e18', border: '#34d39e', text: '#6ee7b7' },
  'Rare':           { bg: '#3b82f618', border: '#3b82f6', text: '#60a5fa' },
  'Legendary':      { bg: '#f59e0b18', border: '#f59e0b', text: '#fbbf24' },
  'Mythical':       { bg: '#a855f718', border: '#a855f7', text: '#c084fc' },
  'Exotic':         { bg: '#ec489918', border: '#ec4899', text: '#f472b6' },
  'Limited':        { bg: '#ef444418', border: '#ef4444', text: '#f87171' },
  'Special':        { bg: '#06b6d418', border: '#06b6d4', text: '#22d3ee' },
  'Secret':         { bg: '#fbbf2418', border: '#fbbf24', text: '#fde68a' },
  'Divine Secret':  { bg: '#fde68a20', border: '#fde68a', text: '#fef3c7' },
  'Apex':           { bg: '#f43f5e18', border: '#f43f5e', text: '#fb7185' },
  'Extinct':        { bg: '#78716c18', border: '#a8a29e', text: '#d6d3d1' },
  'Relic':          { bg: '#c084fc18', border: '#c084fc', text: '#d8b4fe' },
  'Gemstone':       { bg: '#2dd4bf18', border: '#2dd4bf', text: '#5eead4' },
  'Fragment':       { bg: '#67e8f918', border: '#67e8f9', text: '#a5f3fc' },
};
const rc = rarityColors[fish.rarity] || { bg: '#ffffff10', border: '#ffffff40', text: '#e8eaf0' };

// Schema.org
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: `${fish.name} - Fisch Guide`,
  description: metaDesc,
  author: { '@type': 'Organization', name: 'Codigos Gratis' },
  publisher: { '@type': 'Organization', name: 'Codigos Gratis' },
  mainEntityOfPage: new URL(Astro.url.pathname, Astro.site).href,
};

// Info grid items
const infoItems: { label: string; value: string; icon: string }[] = [];
if (fish.baseValue != null) infoItems.push({ label: 'Base Value', value: `${fmt(fish.baseValue)} C$/kg`, icon: 'üí∞' });
if (fish.weightRange) infoItems.push({ label: 'Weight Range', value: `${fmt(fish.weightRange.min)} ‚Äì ${fmt(fish.weightRange.max)} kg`, icon: '‚öñÔ∏è' });
if (fish.baseWeight != null) infoItems.push({ label: 'Base Weight', value: `${fmt(fish.baseWeight)} kg`, icon: 'üèãÔ∏è' });
if (fish.xp != null) infoItems.push({ label: 'XP', value: fmt(fish.xp), icon: '‚≠ê' });
if (fish.baseChance != null && fish.baseChance > 0) infoItems.push({ label: 'Catch Chance', value: `${fish.baseChance}%`, icon: 'üéØ' });
if (fish.baseResil != null) infoItems.push({ label: 'Resilience', value: fmt(fish.baseResil), icon: 'üõ°Ô∏è' });

// Conditions
const conditions: { label: string; value: string; icon: string }[] = [];
if (fish.location) conditions.push({ label: 'Location', value: fish.sublocation ? `${fish.location} ‚Äî ${fish.sublocation}` : fish.location, icon: 'üìç' });
if (fish.bait.length > 0) conditions.push({ label: 'Bait', value: fish.bait.join(', '), icon: 'ü™±' });
if (fish.weather.length > 0) conditions.push({ label: 'Weather', value: fish.weather.join(', '), icon: 'üå§Ô∏è' });
if (fish.time) conditions.push({ label: 'Time', value: fish.time, icon: 'üïê' });
if (fish.season.length > 0) conditions.push({ label: 'Season', value: fish.season.join(', '), icon: 'üìÖ' });
if (fish.event) conditions.push({ label: 'Event', value: fish.event, icon: 'üéâ' });
if (fish.sources.length > 0) conditions.push({ label: 'Source', value: fish.sources.join(', '), icon: 'üé£' });

// Hero max value
const formattedMaxValue = tradingValue?.estimatedValue
  ? fmtC(tradingValue.estimatedValue.max)
  : null;

---

<GameLayout
  title={`${fish.name} - How to Catch, Value & Location | Fisch Guide`}
  description={metaDesc}
  game="Fisch"
  breadcrumbs={[
    { label: 'Fish', href: '/games/fisch/fish/' },
    { label: fish.name, href: `/games/fisch/fish/${fish.id}/` },
  ]}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  </Fragment>

  <!-- HERO -->
  <FischHero
    title={fish.name.toUpperCase()}
    subtitle={fish.rarity}
    bgImage={fish.imageUrl || '/images/fisch-hero.webp'}
  >
    <span
      class="fish-detail__rarity-badge"
      style={`background:${rc.bg}; border-color:${rc.border}; color:${rc.text};`}
    >
      {fish.rarity}
    </span>
    {formattedMaxValue && (
      <div class="fish-detail__giant-val">{formattedMaxValue} C$</div>
    )}
  </FischHero>

  <div class="container">
    <!-- FIELD DATA -->
    {infoItems.length > 0 && (
      <section class="info-section" aria-label="Fish stats">
        <h2 class="section-heading">FIELD DATA</h2>
        <div class="info-grid">
          {infoItems.map(item => (
            <div class="info-card">
              <span class="info-card__icon">{item.icon}</span>
              <span class="info-card__label">{item.label}</span>
              <span class="info-card__value">{item.value}</span>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- CONDITIONS -->
    {conditions.length > 0 && (
      <section class="conditions">
        <h2 class="section-heading">CATCH INTEL</h2>
        <div class="conditions__list">
          {conditions.map(c => (
            <div class="cond-row">
              <span class="cond-row__icon">{c.icon}</span>
              <span class="cond-row__label">{c.label}</span>
              {c.label === 'Location' ? (
                <a href="/games/fisch/locations/" class="cond-row__value cond-row__link">
                  {c.value}
                </a>
              ) : (
                <span class="cond-row__value">{c.value}</span>
              )}
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- VALUE CALCULATOR -->
    {fish.baseValue != null && fish.baseValue > 0 && fish.weightRange && (
      <section class="calc-section">
        <h2 class="section-heading">VALUE ASSESSMENT</h2>
        <FishValueCalc
          client:visible
          baseValue={fish.baseValue}
          weightMin={fish.weightRange.min}
          weightMax={fish.weightRange.max}
          baseWeight={fish.baseWeight || fish.weightRange.min}
          mutations={mutationsData as Mutation[]}
        />
      </section>
    )}

    <!-- TRADING VALUE -->
    {tradingValue && tradingValue.estimatedValue && (
      <section class="trading">
        <h2 class="section-heading">TRADING VALUE</h2>
        <div class="trading__card">
          <div class="trading__row">
            <span class="trading__label">Base Price</span>
            <span class="trading__val">{fmt(tradingValue.basePrice)} C$/kg</span>
          </div>
          <div class="trading__row">
            <span class="trading__label">Est. Value (min)</span>
            <span class="trading__val">{fmtC(tradingValue.estimatedValue.min)} C$</span>
          </div>
          <div class="trading__row">
            <span class="trading__label">Est. Value (max)</span>
            <span class="trading__val trading__val--highlight">{fmtC(tradingValue.estimatedValue.max)} C$</span>
          </div>
          {tradingValue.baseCatchRate != null && tradingValue.baseCatchRate > 0 && (
            <div class="trading__row">
              <span class="trading__label">Catch Rate</span>
              <span class="trading__val">{tradingValue.baseCatchRate}%</span>
            </div>
          )}
        </div>
      </section>
    )}

    <!-- DESCRIPTION -->
    {fish.description && (
      <section class="desc-section">
        <h2 class="section-heading">Description</h2>
        <p class="desc-section__text">{fish.description}</p>
      </section>
    )}

    <!-- QUICK LINKS -->
    <section class="quick-links">
      <h2 class="section-heading">Explore More</h2>
      <div class="quick-links__grid">
        {fish.baseValue != null && fish.baseValue > 0 && (
          <a href="/games/fisch/calculator/" class="quick-link">
            <span class="quick-link__icon">üîÑ</span>
            <span class="quick-link__text">Calculate trade value</span>
          </a>
        )}
        <a href="/games/fisch/values/" class="quick-link">
          <span class="quick-link__icon">üí∞</span>
          <span class="quick-link__text">See current value list</span>
        </a>
        <a href="/games/fisch/mutations/" class="quick-link">
          <span class="quick-link__icon">üß¨</span>
          <span class="quick-link__text">Browse all mutations</span>
        </a>
        {fish.location && (
          <a href={`/games/fisch/locations/`} class="quick-link">
            <span class="quick-link__icon">üìç</span>
            <span class="quick-link__text">All fishing locations</span>
          </a>
        )}
      </div>
    </section>

    <!-- RELATED FISH -->
    {related.length > 0 && (
      <section class="related">
        <h2 class="section-heading">Other {fish.rarity} Fish</h2>
        <div class="related__grid">
          {related.map(r => (
            <a href={`/games/fisch/fish/${r.id}/`} class="related__card">
              <span class="related__name">{r.name}</span>
              {r.baseValue != null && (
                <span class="related__value">{fmt(r.baseValue)} C$/kg</span>
              )}
            </a>
          ))}
        </div>
        <a href="/games/fisch/fish/" class="related__see-all">See all {fish.rarity} fish &rarr;</a>
      </section>
    )}
  </div>
</GameLayout>

<style>
  /* ============================================================
     HERO SLOT ELEMENTS
     ============================================================ */

  .fish-detail__rarity-badge {
    display: inline-block;
    margin-top: 0.25rem;
    padding: 0.2rem 0.75rem;
    border: 1px solid;
    border-radius: 9999px;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  .fish-detail__giant-val {
    font-family: var(--font-mono);
    font-size: clamp(2.5rem, 6vw, 4rem);
    font-weight: 700;
    color: var(--accent-secondary, #22D3EE);
    margin-top: 0.5rem;
    text-shadow: 0 0 40px rgba(34, 211, 238, 0.4);
  }

  /* ============================================================
     INFO GRID
     ============================================================ */

  .info-section {
    padding-bottom: 1.5rem;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.6rem;
  }

  @media (min-width: 480px) {
    .info-grid { grid-template-columns: repeat(3, 1fr); }
  }

  @media (min-width: 768px) {
    .info-grid { grid-template-columns: repeat(6, 1fr); }
  }

  .info-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.15rem;
    padding: 0.75rem 0.5rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    text-align: center;
    transition: border-color 0.2s;
  }

  .info-card:hover {
    border-color: rgba(6, 214, 160, 0.3);
  }

  .info-card__icon {
    font-size: 1.25rem;
  }

  .info-card__label {
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
  }

  .info-card__value {
    font-family: var(--font-display);
    font-size: 0.95rem;
    font-weight: 700;
    color: #fff;
    line-height: 1.2;
  }

  /* ============================================================
     CONDITIONS
     ============================================================ */

  .section-heading {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .conditions {
    padding-bottom: 1.5rem;
  }

  .conditions__list {
    display: flex;
    flex-direction: column;
    gap: 0;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .cond-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.7rem 1rem;
    border-bottom: 1px solid var(--border);
  }

  .cond-row:last-child {
    border-bottom: none;
  }

  .cond-row__icon {
    font-size: 1.1rem;
    flex-shrink: 0;
    width: 1.5rem;
    text-align: center;
  }

  .cond-row__label {
    font-size: 0.8rem;
    color: var(--text-dim);
    min-width: 5.5rem;
    flex-shrink: 0;
    font-weight: 500;
  }

  .cond-row__value {
    font-size: 0.9rem;
    color: #fff;
    font-weight: 600;
  }

  .cond-row__link {
    color: var(--accent);
    transition: opacity 0.2s;
  }

  .cond-row__link:hover {
    opacity: 0.8;
  }

  /* ============================================================
     VALUE CALCULATOR
     ============================================================ */

  .calc-section {
    padding-bottom: 1.5rem;
  }

  /* Styles for the React component */
  .calc-section :global(.calc) {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }

  .calc-section :global(.calc__row) {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .calc-section :global(.calc__label) {
    font-size: 0.8rem;
    color: var(--text-dim);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .calc-section :global(.calc__input),
  .calc-section :global(.calc__select) {
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.55rem 0.75rem;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
  }

  .calc-section :global(.calc__input:focus),
  .calc-section :global(.calc__select:focus) {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(6, 214, 160, 0.15);
  }

  .calc-section :global(.calc__range) {
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  .calc-section :global(.calc__select option) {
    background: var(--bg-card);
    color: var(--text);
  }

  .calc-section :global(.calc__result) {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
    padding: 1rem;
    background: linear-gradient(135deg, rgba(6, 214, 160, 0.08), rgba(14, 165, 233, 0.06));
    border: 1px solid rgba(6, 214, 160, 0.2);
    border-radius: 10px;
    text-align: center;
  }

  .calc-section :global(.calc__result-label) {
    font-size: 0.75rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
  }

  .calc-section :global(.calc__result-value) {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent);
    line-height: 1.2;
  }

  .calc-section :global(.calc__result-formula) {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-top: 0.15rem;
  }

  @media (min-width: 640px) {
    .calc-section :global(.calc) {
      flex-direction: row;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .calc-section :global(.calc__row) {
      flex: 1;
      min-width: 160px;
    }
    .calc-section :global(.calc__result) {
      width: 100%;
    }
  }

  /* ============================================================
     TRADING VALUE
     ============================================================ */

  .trading {
    padding-bottom: 1.5rem;
  }

  .trading__card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .trading__row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.7rem 1rem;
    border-bottom: 1px solid var(--border);
  }

  .trading__row:last-child {
    border-bottom: none;
  }

  .trading__label {
    font-size: 0.85rem;
    color: var(--text-dim);
    font-weight: 500;
  }

  .trading__val {
    font-family: var(--font-display);
    font-size: 0.95rem;
    font-weight: 700;
    color: #fff;
  }

  .trading__val--highlight {
    color: var(--accent);
  }

  /* ============================================================
     DESCRIPTION
     ============================================================ */

  .desc-section {
    padding-bottom: 1.5rem;
  }

  .desc-section__text {
    font-size: 0.95rem;
    color: var(--text-dim);
    line-height: 1.7;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.25rem;
  }

  /* ============================================================
     RELATED FISH
     ============================================================ */

  .related {
    padding-bottom: 1rem;
  }

  .related__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  @media (min-width: 480px) {
    .related__grid { grid-template-columns: repeat(3, 1fr); }
  }

  @media (min-width: 768px) {
    .related__grid { grid-template-columns: repeat(5, 1fr); }
  }

  .related__card {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    padding: 0.65rem 0.75rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    transition: border-color 0.2s, transform 0.2s;
  }

  .related__card:hover {
    border-color: rgba(6, 214, 160, 0.35);
    transform: translateY(-1px);
  }

  .related__name {
    font-size: 0.85rem;
    font-weight: 600;
    color: #fff;
    line-height: 1.3;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .related__value {
    font-size: 0.75rem;
    color: var(--text-dim);
    font-family: var(--font-display);
  }

  .related__see-all {
    display: inline-block;
    margin-top: 0.65rem;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--accent);
    transition: opacity 0.2s;
  }

  .related__see-all:hover {
    opacity: 0.8;
  }

  /* ============================================================
     QUICK LINKS
     ============================================================ */

  .quick-links {
    padding-bottom: 1.5rem;
  }

  .quick-links__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  @media (min-width: 640px) {
    .quick-links__grid { grid-template-columns: repeat(4, 1fr); }
  }

  .quick-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.65rem 0.85rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 0.82rem;
    font-weight: 500;
    color: var(--text);
    transition: border-color 0.2s, transform 0.2s;
  }

  .quick-link:hover {
    border-color: rgba(6, 214, 160, 0.35);
    transform: translateY(-1px);
  }

  .quick-link__icon {
    font-size: 1rem;
    flex-shrink: 0;
  }

  .quick-link__text {
    line-height: 1.3;
  }
</style>
